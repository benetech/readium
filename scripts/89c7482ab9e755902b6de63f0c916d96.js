window.Readium={Models:{},Collections:{},Views:{},Routers:{},Utils:{},Init:function(){BookshareUtils.setEnvironment(window.location.href);$('a[href*="//www.bookshare.org"]').each(function(){this.href=BookshareUtils.resolveEnvironment(this.href)});_router=new Readium.Routers.ViewerRouter;this.Start()},Start:function(){if(BookshareUtils.isIE9()){var a=BookshareUtils.AWS_URL_PATTERN.exec(window.location.href);_router.openBook(a[2])}else Backbone.history.start({pushState:!0})}};$(function(){window.Readium.Init()});
Readium.HttpFileApi=function(){var b={readTextFile:function(a,c,b){$.ajax({url:a,dataType:"text",success:function(a,b,d){c(a,d)},error:function(a,c,d){b(a,c,d)}})},getFsUri:function(a,b){b(document.location.protocol+"//"+document.location.host+a)}};return function(a){a(b);return b}}();Readium.FileSystemApi=Readium.HttpFileApi;
Readium.Utils.setCookie=function(d,a,b){var c=new Date;c.setDate(c.getDate()+b);a=escape(a)+(b==null?"":"; expires="+c.toUTCString());document.cookie=d+"="+a};Readium.Utils.getCookie=function(d){var a,b,c,e=document.cookie.split(";");for(a=0;a<e.length;a++)if(b=e[a].substr(0,e[a].indexOf("=")),c=e[a].substr(e[a].indexOf("=")+1),b=b.replace(/^\s+|\s+$/g,""),b==d)return unescape(c)};Readium.Utils.trimString=function(d){return d.replace(/^\s+|\s+$/g,"")};
BBFileSystemSync=function(a,b,c){if(!b.file_path)throw"Cannot sync the model to the fs without a path";switch(a){case "read":Readium.FileSystemApi(function(a){a.readTextFile(b.file_path,function(a){c.success(a)},function(a){c.error(a)})});break;case "create":throw"Not yet implemented";case "update":throw"Not yet implemented";case "delete":throw"Not yet implemented";}return null};
Readium.Utils.Guid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(d){var b=Math.random()*16|0;return(d=="x"?b:b&3|8).toString(16)})};
Readium.Utils.LocalStorageAdaptor=function(d){var b,f=function(){localStorage.setItem(d,JSON.stringify(b))};return function(h,a,e){var c,g=localStorage.getItem(d);b=g&&JSON.parse(g)||{};switch(h){case "read":c=a.id?b[a.id]:_.values(b);break;case "create":if(!a.id)a.id=a.attributes.id=guid();b[a.id]=a;f();c=a;break;case "update":b[a.id]=a;f();c=a;break;case "delete":delete b[a.id],f(),c=a}c?e.success&&e.success(c):e.error&&e.error("Record not found")}};
Readium.Models.AlternateStyleTagSelector=Backbone.Model.extend({initialize:function(){},activateAlternateStyleSet:function(b,a){var d,c=[];if(b.length===0)return a;d=$("link[rel*='stylesheet']",a);if(d.length===0)return a;d=this._storeOriginalAttributes(d);c=this._getStyleSetTitles(d);c=this._getStyleSetTitleToActivate(d,c,b);if(c===null)return a;this._activateStyleSet(d,c);return a},_activateStyleSet:function(b,a){b.each(function(){$styleSheet=$(this);$styleSheet.attr("rel","stylesheet");$styleSheet.attr("title")===
void 0?$styleSheet[0].disabled=!1:$.trim($styleSheet.attr("title"))===a?($styleSheet[0].disabled=!0,$styleSheet[0].disabled=!1):$styleSheet[0].disabled=!0});return b},_storeOriginalAttributes:function(b){var a;b.each(function(){a=$(this);a.data("orig-rel")===void 0&&a.attr("data-orig-rel",a.attr("rel"))});return b},_getStyleSetTitleToActivate:function(b,a,d){var c=[],g,e,h,f=[];for(g=0;g<a.length;g+=1)e=b.filter("link[title='"+a[g]+"']"),e=this._removeMutuallyExclusiveAltTags(e),c.push({numAltTagMatches:this._getNumAltStyleTagMatches(e,
d),styleSetTitle:a[g]});h=_.max(c,function(a){return a.numAltTagMatches}).numAltTagMatches;if(h===0)return null;_.each(c,function(a){a.numAltTagMatches===h&&f.push(a.styleSetTitle)});if(f!==1)for(a=0;a<f.length;a++)if(e=b.filter("link[title='"+f[a]+"']"),$.trim($(e[0]).attr("data-orig-rel"))==="stylesheet")return f[a];return f[0]},_getStyleSetTitles:function(b){var a=[];b.each(function(){var b=$(this).attr("title");_.include(a,b)||a.push(b)});return a},_getNumAltStyleTagMatches:function(b,a){var d=
0,c;for(c=0;c<a.length;c+=1)b.filter("link[class*='"+a[c]+"']").length>0&&d++;return d},_removeMutuallyExclusiveAltTags:function(b){var a;b.filter("link[class*='night']").length>0&&b.filter("link[class*='day']").length>0&&b.each(function(){a=$(this);a.filter(".night").length>0&&a.toggleClass("night");a.filter(".day").length>0&&a.toggleClass("day")});b.filter("link[class*='vertical']").length>0&&b.filter("link[class*='horizontal']").length>0&&b.each(function(){a=$(this);a.filter(".vertical").length>
0&&a.toggleClass("vertical");a.filter(".horizontal").length>0&&a.toggleClass("horizontal")});return b}});
Readium.Models.ManifestItem=Backbone.Model.extend({parseMetaTags:function(){var a;typeof this.get("meta_width")==="undefined"&&(this.isSvg()?a=this.parseViewboxTag():this.isImage()||(a=this.parseViewportTag()),a&&this.set({meta_width:a.width,meta_height:a.height}))},getContentDom:function(){var a=this.get("content");if(a)return(new window.DOMParser).parseFromString(a,"text/xml")},parseViewportTag:function(){var a=this.getContentDom();if(a){a=$("[name='viewport']",a)[0];if(!a)return null;for(var a=
a.getAttribute("content"),a=a.replace(/\s/g,""),a=a.split(","),b={},c,d=0;d<a.length;d++)c=a[d].split("="),c.length===2&&(b[c[0]]=c[1]);b.width=parseFloat(b.width,10);b.height=parseFloat(b.height,10);return b}},parseViewboxTag:function(){var a=this.getContentDom();if(a){var a=a.documentElement.getAttribute("viewBox").split(/,?\s+|,/),b={};b.width=parseFloat(a[2],10);b.height=parseFloat(a[3],10);return b}},resolvePath:function(a){return this.collection.packageDocument.resolvePath(a)},resolveUri:function(a){return this.collection.packageDocument.resolveUri(a)},
isSvg:function(){return this.get("media_type")==="image/svg+xml"},isImage:function(){var a=this.get("media_type");return a&&a.indexOf("image/")>-1?a!=="image/svg+xml":!1},loadContent:function(){var a=this,b=this.resolvePath(this.get("href"));Readium.FileSystemApi(function(c){c.readTextFile(b,function(b){a.set({content:b})},function(){console.log("Failed to load file: "+b)})})}});
Readium.Models.SpineItem=Readium.Models.ManifestItem.extend({initialize:function(){this.isFixedLayout()&&(this.on("change:content",this.parseMetaTags,this),this.loadContent())},buildSectionJSON:function(a,b){if(!a)return null;var c=Object.create(null);c.width=this.get("meta_width")||0;c.height=this.get("meta_height")||0;c.uri=this.packageDocument.resolveUri(a.get("href"));c.page_class=this.getPageSpreadClass(a,b);return c},toJSON:function(){this.isFixedLayout()&&this.parseMetaTags();var a={};a.width=
this.get("meta_width")||0;a.height=this.get("meta_height")||0;a.uri=this.resolveUri(this.get("href"));a.page_class=this.getPageSpreadClass();return a},getPageSpreadClass:function(){var a=this.collection.packageDocument.get("book"),b=this.get("spine_index");return a.get("apple_fixed")?b===0?"center_page":b%2===1&&b===this.collection.length?"center_page":b%2===0?"right_page":"left_page":this.get("page_spread")?(a=this.get("page_spread"),a==="left"?"left_page":a==="right"?"right_page":"center_page"):
this.get("page_prog_dir")==="rtl"?b%2===0?"right_page":"left_page":b%2===0?"left_page":"right_page"},isFixedLayout:function(){return this.isSvg()||this.isImage()?!0:typeof this.get("fixed_flow")!=="undefined"?this.get("fixed_flow"):this.collection.isBookFixedLayout()},getPageView:function(){if(!this.view)this.view=this.isImage()?new Readium.Views.ImagePageView({model:this}):new Readium.Views.FixedPageView({model:this});return this.view}});
Readium.Collections.ManifestItems=Backbone.Collection.extend({model:Readium.Models.ManifestItem,initialize:function(a,b){this.packageDocument=b.packageDocument}});Readium.Collections.Spine=Backbone.Collection.extend({model:Readium.Models.SpineItem,initialize:function(a,b){this.packageDocument=b.packageDocument},isBookFixedLayout:function(){return this.packageDocument.get("book").isFixedLayout()}});
Readium.Models.PackageDocumentParser=function(a){this.uri_obj=a};
Readium.Models.PackageDocumentParser.JathTemplate={metadata:{id:"//def:metadata/dc:identifier",epub_version:"//def:package/@version",title:"//def:metadata/dc:title",author:"//def:metadata/dc:creator",publisher:"//def:metadata/dc:publisher",description:"//def:metadata/dc:description",rights:"//def:metadata/dc:rights",language:"//def:metadata/dc:language",pubdate:"//def:metadata/dc:date",modified_date:"//def:metadata/def:meta[@property='dcterms:modified']",layout:"//def:metadata/def:meta[@property='rendition:layout']",
spread:"//def:metadata/def:meta[@property='rendition:spread']",orientation:"//def:metadata/def:meta[@property='rendition:orientation']",ncx:"//def:spine/@toc",page_prog_dir:"//def:spine/@page-progression-direction",active_class:"//def:metadata/def:meta[@property='media:active-class']"},manifest:["//def:item",{id:"@id",href:"@href",media_type:"@media-type",properties:"@properties",media_overlay:"@media-overlay"}],spine:["//def:itemref",{idref:"@idref",properties:"@properties",linear:"@linear"}],bindings:["//def:bindings/def:mediaType",
{handler:"@handler",media_type:"@media-type"}]};
Readium.Models.PackageDocumentParser.prototype.parse=function(a){var c;c=typeof a==="string"?(new window.DOMParser).parseFromString(a,"text/xml"):a;a={};a.metadata=this.getJsonMetadata(c);a.bindings=this.getJsonBindings(c);a.spine=this.getJsonSpine(c);a.manifest=this.getJsonManifest(c);a.paginate_backwards=this.paginateBackwards(c);if(c=this.getCoverHref(c))a.metadata.cover_href=this.resolveUri(c);if(a.metadata.layout==="pre-paginated")a.metadata.fixed_layout=!0;a.manifest=new Readium.Collections.ManifestItems(a.manifest,
{packageDocument:this});a.spine=this.parseSpineProperties(a.spine);return a};Readium.Models.PackageDocumentParser.prototype.getJsonSpine=function(a){var c=[],a=$("spine",a).children();$.each(a,function(a,e){var d=$(e),d={idref:d.attr("idref")?d.attr("idref"):"",linear:d.attr("linear")?d.attr("linear"):"",properties:d.attr("properties")?d.attr("properties"):""};c.push(d)});return c};
Readium.Models.PackageDocumentParser.prototype.getJsonMetadata=function(a){var c=$("metadata",a),b={};b.active_class=$("meta[property='media:active-class']",c).text();b.author=$("creator",c).text();b.description=$("description",c).text();b.epub_version=$("package",a).attr("version")?$("package",a).attr("version"):"";b.id=$("identifier",c).text();b.language=$("language",c).text();b.layout=$("meta[property='rendition:layout']",c).text();b.modified_date=$("meta[property='dcterms:modified']",c).text();
b.ncx=$("spine",a).attr("toc")?$("spine",a).attr("toc"):"";b.orientation=$("meta[property='rendition:orientation']",c).text();b.page_prog_dir=$("spine",a).attr("page-progression-direction")?$("spine",a).attr("page-progression-direction"):"";b.pubdate=$("date",c).text();b.publisher=$("publisher",c).text();b.rights=$("rights").text();b.spread=$("meta[property='rendition:spread']",c).text();b.title=$("title",c).text();return b};
Readium.Models.PackageDocumentParser.prototype.getJsonManifest=function(a){var a=$("manifest",a).children(),c=[];$.each(a,function(a,e){var d=$(e),d={href:d.attr("href")?d.attr("href"):"",id:d.attr("id")?d.attr("id"):"",media_overlay:d.attr("media-overlay")?d.attr("media-overlay"):"",media_type:d.attr("media-type")?d.attr("media-type"):"",properties:d.attr("properties")?d.attr("properties"):""};c.push(d)});return c};
Readium.Models.PackageDocumentParser.prototype.getJsonBindings=function(a){var a=$("bindings",a).children(),c=[];$.each(a,function(a,e){var d=$(e),d={handler:d.attr("handler")?d.attr("handler"):"",media_type:d.attr("media-type")?d.attr("media-type"):""};c.push(d)});return c};
Readium.Models.PackageDocumentParser.prototype.getCoverHref=function(a){var c,b;c=a.getElementsByTagName("manifest")[0];b=$('item[properties~="cover-image"]',c);if(b.length===1&&b.attr("href"))return b.attr("href");a=$('meta[name="cover"]',a);b=a.attr("content");if(a.length===1&&b&&(b=$('item[id="'+b+'"]',c),b.length===1&&b.attr("href")))return b.attr("href");b=$("#cover",c);return b.length===1&&b.attr("href")?b.attr("href"):null};
Readium.Models.PackageDocumentParser.prototype.parseSpineProperties=function(a){for(var c=function(a){for(var c={},a=a.split(" "),b=0;b<a.length;b++){if(a[b]==="rendition:page-spread-center")c.page_spread="center";if(a[b]==="page-spread-left")c.page_spread="left";if(a[b]==="page-spread-right")c.page_spread="right";if(a[b]==="page-spread-right")c.page_spread="right";if(a[b]==="rendition:layout-reflowable")c.fixed_flow=!1;if(a[b]==="rendition:layout-pre-paginated")c.fixed_flow=!0}return c},b=0;b<a.length;b++){var e=
c(a[b].properties);_.extend(a[b],e)}return a};Readium.Models.PackageDocumentParser.prototype.paginateBackwards=function(a){return $("spine",a).attr("page-progression-direction")==="ltr"};
Readium.Models.PackageDocumentParser.prototype.crunchSpine=function(a,c){var b=this,e=-1,d=_.map(a,function(a){e+=1;var d=c.find(function(b){if(b.get("id")===a.idref)return b}),f=b.get("book");return _.extend({},a,d.attributes,{spine_index:e},{page_prog_dir:f.get("page_prog_dir")})});return new Readium.Collections.Spine(d,{packageDocument:this})};Readium.Models.PackageDocumentParser.prototype.resolveUri=function(a){uri=new URI(a);return uri.resolve(this.uri_obj).toString()};
Readium.Models.PackageDocument=Backbone.Model.extend({initialize:function(a){var b=this;if(a.file_path)this.file_path=a.file_path,Readium.FileSystemApi(function(a){a.getFsUri(b.file_path,function(a){b.uri_obj=new URI(a)})});else throw"This class cannot be synced without a file path";this.on("change:spine_position",this.onSpinePosChanged)},onSpinePosChanged:function(){this.get("spine_position")>=this.previous("spine_position")?this.trigger("increased:spine_position"):this.trigger("decreased:spine_position")},
validate:function(a){if(!a.manifest&&!this.get("manifest"))return"ERROR: All ePUBs must have a manifest";var b=a.spine||this.get("spine");if(!b)return"ERROR: All ePUBs must have a spine";if(a.spine_position<0||a.spine_position>=b.length)return"ERROR: invalid spine position"},sync:BBFileSystemSync,defaults:{spine_position:0},getManifestItemById:function(a){return this.get("manifest").find(function(b){if(b.get("id")===a)return b})},getSpineItem:function(a){return this.get("res_spine").at(a)},spineLength:function(){return this.get("res_spine").length},
getNextLinearSpinePostition:function(a){var b=this.get("res_spine");if(a===void 0||a<-1)a=-1;for(;a<b.length-1;)if(a+=1,b.at(a).get("linear")!=="no")return a;return-1},getPrevLinearSpinePostition:function(a){var b=this.get("res_spine");if(a===void 0||a>b.length)a=b.length;for(;a>0;)if(a-=1,b.at(a).get("linear")!=="no")return a;return-1},goToNextSection:function(){this.set({spine_position:this.get("spine_position")+1})},goToPrevSection:function(){this.set({spine_position:this.get("spine_position")-
1})},spineIndexFromHref:function(a){for(var b=this.get("res_spine"),a=this.resolveUri(a).replace(/#.*$/,""),c=0;c<b.length;c++){var d=b.at(c).get("href"),d=this.resolveUri(d).replace(/#.*$/,"");if(d===a)return c}return-1},goToHref:function(a){var b=this.get("spine"),c=this.get("manifest"),d=this,a=d.resolveUri(a).replace(/#.*$/,""),c=c.find(function(b){var c=d.resolveUri(b.get("href")).replace(/#.*$/,"");if(a==c)return b});if(!c)return null;for(var c=c.get("id"),e=0;e<b.length;++e)if(b[e].idref===
c){this.set({spine_position:e},{silent:!0});this._previousAttributes.spine_position=0;this.trigger("change:spine_position");break}},getTocItem:function(){var a=this.get("manifest"),b=this.get("metadata").ncx,c=a.find(function(a){return a.get("properties")==="nav"});return c?c:b&&b.length>0?a.find(function(a){return a.get("id")===b}):null},crunchSpine:function(a,b){var c=this,d=-1,e=_.map(a,function(a){d+=1;var e=b.find(function(b){if(b.get("id")===a.idref)return b}),f=c.get("book");return _.extend({},
a,e.attributes,{spine_index:d},{page_prog_dir:f.get("page_prog_dir")})});return new Readium.Collections.Spine(e,{packageDocument:this})},parse:function(a){a=(new Readium.Models.PackageDocumentParser(this.uri_obj)).parse(a);a.res_spine=this.crunchSpine(a.spine,a.manifest);return a},resolveUri:function(a){uri=new URI(a);return uri.resolve(this.uri_obj).toString()},resolvePath:function(a){var b=this.file_path,a=a.indexOf("../")===0?a.substr(3):a,c=b.lastIndexOf("/");return b.substr(0,c)+"/"+a}});
Readium.Models.EPUBController=Backbone.Model.extend({initialize:function(){var a=this;this.epub=this.get("epub");this.options=Readium.Models.ReadiumOptions.getInstance();this.set("columns_supported",Modernizr.testProp(Modernizr.prefixed("columnWidth")));this.get("columns_supported")||this.options.set("pagination_mode","scrolling");var c=window.navigator.userAgent;c.indexOf("Safari")>=0&&c.indexOf("Mobile")>=0&&(this.set("isIosDevice",!0),this.options.set("pagination_mode","single"));this.options.set("controller",
this);this.options.applyOptions();this.paginator=new Readium.Models.PaginationStrategySelector({book:this});this.packageDocument=this.epub.getPackageDocument();this.packageDocument.fetch({success:function(){var b=a.restorePosition();a.set("spine_position",b);a.set("reading_position",a.loadReadingPosition());b=a.paginator.renderSpineItems(!1);a.set("rendered_spine_items",b);a.set("has_toc",!!a.packageDocument.getTocItem())}});this.on("change:spine_position",this.savePosition,this);this.on("change:spine_position",
this.clearReadingPosition,this);this.on("change:spine_position",this.setMetaSize,this);this.on("change:reading_position",this.saveReadingPosition,this);if(BookshareUtils.hasSpeechAPI())this.ttsPlayer=new Readium.Models.TTSPlayer({controller:this}),this.on("change:voice_uri",this.setTTSVoice,this);this.on("change:font_face",this.reportFontChange,this);this.on("change:current_theme",this.reportThemeChange,this);this.on("change:beeline_theme",this.reportThemeChange,this)},defaults:{font_size:10,font_face:"default",
display_page_numbers:!0,should_scroll:!1,two_up:!1,full_screen:!1,toolbar_visible:!0,toc_visible:!1,rendered_spine_items:[],current_theme:"default-theme",current_margin:3,track_position:!0,reading_position:null,beeline_theme:"bright"},toggleFullScreen:function(){this.set({full_screen:!this.get("full_screen")})},increaseFont:function(){this.set({font_size:this.get("font_size")+1})},decreaseFont:function(){this.set({font_size:this.get("font_size")-1})},toggleToc:function(){this.set("toc_visible",!this.get("toc_visible"))},
goToHref:function(a){a=BookshareUtils.getSplitUrl(a);this.trigger("goToHref");a[1]&&this.setSpinePos(this.packageDocument.spineIndexFromHref(a[1]),!1,a[2])},getToc:function(){var a=this.packageDocument.getTocItem();return a?Readium.Models.Toc.getToc(a,{file_path:this.resolvePath(a.get("href")),book:this}):null},getCurrentSection:function(a){a||(a=0);return this.packageDocument.getSpineItem(this.get("spine_position")+a)},isFixedLayout:function(){return this.epub.isFixedLayout()},restorePosition:function(){var a=
Readium.Utils.getCookie(this.epub.get("key"));return parseInt(a,10)||this.packageDocument.getNextLinearSpinePostition()},savePosition:function(){Readium.Utils.setCookie(this.epub.get("key"),this.get("spine_position"),365)},loadReadingPosition:function(){return Readium.Utils.getCookie(this.epub.get("key")+"_rp")},saveReadingPosition:function(){this.get("reading_position")!=null&&Readium.Utils.setCookie(this.epub.get("key")+"_rp",this.get("reading_position"),365)},clearReadingPosition:function(){this.set("reading_position",
null)},resolvePath:function(a){return this.packageDocument.resolvePath(a)},hasNextSection:function(){return this.packageDocument.getPrevLinearSpinePostition(this.get("spine_position"))>-1},hasPrevSection:function(){return this.packageDocument.getNextLinearSpinePostition(this.get("spine_position"))>-1},goToNextSection:function(){var a=this.packageDocument.getNextLinearSpinePostition(this.get("spine_position"));a>-1?this.setSpinePos(a,!1):alert("You have reached the end of this book.")},goToPrevSection:function(){var a=
this.packageDocument.getPrevLinearSpinePostition(this.get("spine_position"));a>-1?this.setSpinePos(a,!0):alert("You are at the beginning of this book.")},setSpinePos:function(a,c,b){if(!(a<0||a>=this.packageDocument.spineLength())){var d=this.get("rendered_spine_items").indexOf(a)>=0?!0:!1;this.set("spine_position",a);this.trigger("FXL_goToPage");d?!this.isFixedLayout()&&b&&this.paginator.v.goToHashFragment(b):this.set("rendered_spine_items",this.paginator.renderSpineItems(c,b))}},setMetaSize:function(){this.meta_section&&
this.meta_section.off("change:meta_height",this.setMetaSize);this.meta_section=this.getCurrentSection();this.meta_section.get("meta_height")&&this.set("meta_size",{width:this.meta_section.get("meta_width"),height:this.meta_section.get("meta_height")});this.meta_section.on("change:meta_height",this.setMetaSize,this)},setTTSVoice:function(){var a=this.get("voice_uri"),c=speechSynthesis.getVoices();for(i=0;i<c.length;i++){var b=c[i];if(b.voiceURI==a){this.ttsPlayer.set("voice",b);break}}},reportFontChange:function(){var a=
this.get("font_face");ga("send","event","Set Preference","Font Face",a?a:"default")},reportThemeChange:function(){var a=this.get("current_theme"),c=this.get("beeline_theme");ga("send","event","Set Preference","Theme",a+(a=="beeline-theme"?"-"+c:""))}});setInterval(function(){window._epub.packageDocument.fetch({success:function(){}})},18E5);
Readium.Models.TTSPlayer=Backbone.Model.extend({defaults:{tts_playing:!1,currentNode:null,bufferSize:5E3,currentSpeech:null,voice:null},ALWAYS_SPEAK:["ol","ul","dl","table"],initialize:function(){this.controller=this.get("controller");this.bufferSize=this.get("bufferSize");this.controller.on("change:spine_position",this.stop,this);this.controller.on("goToHref",this.stop,this);this.controller.on("change:options-view-shown",this.stop,this);this.controller.on("change:toc_visible",this.stop,this);this.controller.on("pagesNextPage",
this.stop,this);this.controller.on("pagesPrevPage",this.stop,this);this.controller.on("repagination_event",this._windowSizeChangeHandler,this);$(window).unload(function(){speechSynthesis.cancel()})},play:function(){this.set("tts_playing",!0);this.controller.set("track_position",!1);this._setCurrentNode(this._getStartNode());this.speak()},stop:function(){speechSynthesis.pause();this.set("tts_playing",!1);this.set("currentNode",null);this.controller.set("track_position",!0);this.data=null;speechSynthesis.cancel()},
speak:function(){var a=this._getCurrentNode();if(a!=null){console.debug("SPEAKING: "+this._getCurrentNode().id);this.data=BeneSpeak.generateSpeechData(a);a=new SpeechSynthesisUtterance(this.data.utterance);console.debug("TTS TEXT: "+a.text.substr(0,40));a.voice=this.get("voice");a.rate=this.controller.options.get("speech_rate");var b=this._createCallbackHandler(this);a.onboundary=b;a.onend=b;a.onerror=b;speechSynthesis.speak(a);this.set("currentSpeech",a)}else this.stop()},advanceReadingPosition:function(){var a=
this._getCurrentNode(),a=this._getNextReadableNode(a);a!=null&&this._setCurrentNode(a);return a},_getNextReadableNode:function(a,b){var c=b?a:this._getNextNode(a);return c!=null?this._shouldRead(c)?this._shouldDescend(c)?this._getNextReadableNode(c.childNodes[0],!0):c:this._getNextReadableNode(c):null},_shouldDescend:function(a){if(a.nodeType==Node.ELEMENT_NODE){for(var b=!1,a=a.childNodes,c=0;c<a.length;c++){var d=a[c];if(d.nodeType==Node.ELEMENT_NODE&&(b=!0,!BeneSpeak._isBlockElement(d)))return!1}return b}else return!1},
_shouldRead:function(a){return a!=null&&a.textContent.trim().length>0&&(a.nodeType!=Node.ELEMENT_NODE||window.frames[0].getComputedStyle(a).display!="none"||a.getAttribute("epub:type")=="annotation")},_getStartNode:function(){var a=this.controller.paginator.v.getBody().ownerDocument.body;return $(a).find(this.controller.get("reading_position"))[0]||a.children[0]},_setCurrentNode:function(a){this.set("currentNode",a);a.nodeType==Node.ELEMENT_NODE&&a.getAttribute("id")!=null&&this.controller.set("reading_position",
a.tagName.toLowerCase()+"#"+a.getAttribute("id"))},_getCurrentNode:function(){return this.get("currentNode")},_getNextNode:function(a){return a.nextSibling!=null?a.nextSibling:a.parentNode!=null?this._getNextNode(a.parentNode):null},_hasBlockLevelChildrenOnly:function(a){if(a.hasChildNodes()==!0){for(var b=a.childNodes.length,c=0;c<b;c++){var d=a.childNodes[c];if(d.nodeType==Node.TEXT_NODE&&d.textContent.trim().length>0)return!1;else if(d.nodeType!=Node.TEXT_NODE&&!BeneSpeak._isBlockElement(d))return!1}return!0}else return!1},
_createCallbackHandler:function(a){var b=a.data;return function(c){console.debug("EVENT: "+c.type+" "+c.name+" "+c.charIndex);if(c.type=="boundary"&&c.name=="word"){a.controller.options.get("pagination_mode")=="scrolling"?(b.xOffset=a.controller.paginator.v.getFrame().contentWindow.scrollX,b.yOffset=a.controller.paginator.v.getFrame().contentWindow.scrollY):(b.xOffset=b._getOffset(b.document.documentElement.style.left),b.yOffset=b._getOffset(b.document.documentElement.style.top));var d=b.sentenceAt(c.charIndex);
d>=0&&b.highlightSentence(d);c=b.wordAt(c.charIndex);c>=0&&(d=a._getEnclosingAside(b.words[c].range.startContainer.parentElement),d!=null&&d.getAttribute("epub:type")=="annotation"?a._highlightImageGroup(d):b.highlightWord(c),a._updatePagePosition(b))}else if(c.type=="end")console.debug("END OF: "+a._getCurrentNode()),b.clearWordHighlight(),b.clearSentenceHighlight(),console.debug("TTS PLAYING? "+a.get("tts_playing")),a.get("tts_playing")&&a.advanceReadingPosition()!=null?(this.onend=null,console.debug("NEXT: "+
a._getCurrentNode().id),setTimeout(_.bind(a.speak,a),100)):setTimeout(_.bind(a.stop,a),100);else if(c.type=="error")console.debug("A TTS Error was encountered."),this.onerror=null,b.clearWordHighlight(),b.clearSentenceHighlight(),a.get("tts_playing")&&setTimeout(_.bind(a.stop,a),100)}},_updatePagePosition:function(a){var b=this.controller.paginator.v;b.getElemPageNumber!=null?a._wordRects.length>0&&(a=b.getElemPageNumber(a._wordRects[0]),b.pages.isPageVisible(a)||b.pages.goToPage(a)):a._wordRects.length>
0&&b.keepInCenter(a._wordRects[0])},_windowSizeChangeHandler:function(){if(this.get("tts_playing")){var a=this.data._highlightedSentence;this.data.clearSentenceHighlight();this.data.highlightSentence(a)}},_getEnclosingAside:function(a){for(;a!=null;)if(a.tagName.toLowerCase()=="aside")break;else a=a.parentElement;return a},_highlightImageGroup:function(a){this.data.clearWordHighlight();for(var a=a.parentElement.getClientRects(),b=0;b<a.length;b++){var c=this.data.document.createElement("div");this.data.document.body.appendChild(c);
c.className="ttsImgHL";c.style.position="absolute";c.style.top=a[b].top+window.scrollY+this.data.yOffset+"px";c.style.left=a[b].left+window.scrollX+this.data.xOffset+"px";c.style.width=a[b].width+"px";c.style.height=a[b].height+"px";this.data._wordRects.push(c)}},_logPath:function(a){var b="";if(a.nodeType==Node.TEXT_NODE)b="#text",a=a.parentElement;for(;a!=null;)var c=a.getAttribute("id"),b=a.tagName+(c!=null?"["+c+"]":"")+"/"+b,a=a.parentElement;return b}});
Readium.Models.ReadiumOptions=Backbone.Model.extend({initialize:function(){this.set("id","singleton")},defaults:{hijack_epub_urls:!1,verbose_unpacking:!0,display_page_numbers:!0,font_size:10,font_face:"default",speech_rate:1,current_margin:3,current_theme:"default-theme",pagination_mode:"scrolling",show_beeline_alert:"true"},sync:Readium.Utils.LocalStorageAdaptor("READIUM_OPTIONS"),applyOptions:function(){var a=this.get("controller");a.set({font_size:this.get("font_size"),font_face:this.get("font_face"),
display_page_numbers:this.get("display_page_numbers"),current_theme:this.get("current_theme"),beeline_theme:this.get("beeline_theme"),current_margin:this.get("current_margin"),speech_rate:this.get("speech_rate"),voice_uri:this.get("voice_uri")});this.get("pagination_mode")=="scrolling"?a.set("should_scroll",!0):(a.set("should_scroll",!1),this.get("pagination_mode")=="facing"!==a.get("two_up")&&a.set("two_up",!a.get("two_up")));this.save()},resetOptions:function(){var a=this.get("controller");this.fetch();
this.set("controller",a)}},{getInstance:function(){var a=new Readium.Models.ReadiumOptions;a.fetch({error:function(){localStorage.setItem("READIUM_OPTIONS","");a.save()}});return a}});
Readium.Models.Toc=Backbone.Model.extend({sync:BBFileSystemSync,initialize:function(a){this.file_path=a.file_path;this.book=a.book;this.book.on("change:toc_visible",this.setVisibility,this);this.book.on("change:toolbar_visible",this.setTocVis,this);this.book.on("change:reading_position",this.updateTocHighlight,this)},handleLink:function(a){this.book.goToHref(a)},setVisibility:function(){this.set("visible",this.book.get("toc_visible"))},hide:function(){this.book.set("toc_visible",!1)},setTocVis:function(){!this.book.get("toolbar_visible")&&
this.book.get("toc_visible")&&this.book.set("toc_visible",!1)},findNearestTocItemSelector:function(){return null},updateTocHighlight:function(){if(this.book.get("toc_visible")){var a=this.book.get("reading_position"),b=this.book.paginator.v.getBody(),a=$(b).find(a);a.length>0&&this.set("toc_highlight_selector",this.findNearestTocItemSelector(a[0]))}},defaults:{visible:!1}},{XHTML_MIME:"application/xhtml+xml",XML_MIME:"text/xml",NCX_MIME:"application/x-dtbncx+xml",getToc:function(a,b){var c=a.get("media_type");
if(c===Readium.Models.Toc.XHTML_MIME||c===Readium.Models.Toc.XML_MIME)return new Readium.Models.XhtmlToc(b);else if(c===Readium.Models.Toc.NCX_MIME)return new Readium.Models.NcxToc(b)}});
Readium.Models.NcxToc=Readium.Models.Toc.extend({jath_template:{title:"//ncx:docTitle/ncx:text",navs:["//ncx:navMap/ncx:navPoint",{text:"ncx:navLabel/ncx:text",href:"ncx:content/@src"}]},parse:function(a){typeof a==="string"&&(a=(new window.DOMParser).parseFromString(a,"text/xml"));Jath.resolver=function(a){return a==="ncx"?"http://www.daisy.org/z3986/2005/ncx/":""};return Jath.parse(this.jath_template,a)},TocView:function(){return new Readium.Views.NcxTocView({model:this})}});
Readium.Models.XhtmlToc=Readium.Models.Toc.extend({parse:function(a){var b={};typeof a==="string"&&(a=(new window.DOMParser).parseFromString(a,"text/xml"));b.title=$("title",a).text();b.body=$("body",a);b.toc_ids=[];$(b.body).find("nav[epub\\:type='toc'] a[href*='#']").each(function(a,d){b.toc_ids.push(d.getAttribute("href").split("#")[1])});return b},findNearestTocItemSelector:function(a){var b=null;if(a!=null){var c=a.getAttribute("id");this.get("toc_ids").indexOf(c)>-1?b="a[href$='#"+c+"']":a.previousElementSibling!=
null?b=this.findNearestTocItemSelector(a.previousElementSibling):a.parentElement!=null&&(b=this.findNearestTocItemSelector(a.parentElement))}return b},TocView:function(){return new Readium.Views.XhtmlTocView({model:this})}});
Readium.Models.PaginationStrategySelector=Backbone.Model.extend({renderToLastPage:!1,initialize:function(){var a=this;this.model=this.get("book");this.model.on("change:should_scroll",function(){a.renderSpineItems()});this.zoomer=new Readium.Views.FixedLayoutBookZoomer},renderSpineItems:function(a,c){var b=this.model;this.v&&this.v.destruct();b.getCurrentSection();this.v=this.shouldScroll()?new Readium.Views.InjectedScrollingPaginationView({model:b,zoomer:this.zoomer}):new Readium.Views.InjectedReflowablePaginationView({model:b,
zoomer:this.zoomer});return this.rendered_spine_positions=this.v.render(!!a,c)},shouldScroll:function(){return!!this.model.get("should_scroll")}});
Readium.Models.Trigger=function(a){a=$(a);this.action=a.attr("action");this.ref=a.attr("ref");this.event=a.attr("ev:event");this.observer=a.attr("ev:observer");this.ref=a.attr("ref")};Readium.Models.Trigger.prototype.subscribe=function(a){var b=this;$("#"+this.observer,a).on(this.event,function(){b.execute(a)})};
Readium.Models.Trigger.prototype.execute=function(a){a=$("#"+this.ref,a);switch(this.action){case "show":a.css("visibility","visible");break;case "hide":a.css("visibility","hidden");break;case "play":a[0].currentTime=0;a[0].play();break;case "pause":a[0].pause();break;case "resume":a[0].play();break;case "mute":a[0].muted=!0;break;case "unmute":a[0].muted=!1;break;default:console.log("do not no how to handle trigger "+this.action)}};
Readium.Views.PaginationViewBase=Backbone.View.extend({el:"#readium-book-view-el",initialize:function(a){this.zoomer=a.zoomer;this.pages=new Readium.Models.ReadiumPagination({model:this.model});this.pages.on("change:current_page",this.showCurrentPages,this);this.model.on("change:display_page_numbers",this.pageNumberCallback,this);this.model.on("change:font_size",this.fontSizeCallback,this);this.model.on("change:font_face",this.fontFaceCallback,this);this.bindingTemplate=Handlebars.templates.binding_template;
this.shortcutTemplate=Handlebars.templates.iframe_keyboard_shortcuts},iframeLoadCallback:function(a){this.applyBindings($(a.srcElement).contents());this.applySwitches($(a.srcElement).contents());this.addSwipeHandlers($(a.srcElement).contents());this.injectHighlightStyles(a.srcElement);this.injectPageNumberStyles(a.srcElement);this.togglePageNumbers();this.injectLinkHandler(a.srcElement);this.injectKeyboardSupport(a.srcElement);var b=this.parseTriggers(a.srcElement.contentDocument);this.applyTriggers(a.srcElement.contentDocument,
b)},activateEPubStyle:function(a){var b;this.model.get("current_theme")==="night-theme"||this.model.get("current_theme")==="beeline-theme"&&this.model.get("beeline_theme")=="night_gray"?(b=new Readium.Models.AlternateStyleTagSelector,b.activateAlternateStyleSet(["night"],a)):(b=new Readium.Models.AlternateStyleTagSelector,b.activateAlternateStyleSet([""],a))},setUpMode:function(){var a=this.model.get("two_up");this.$el.toggleClass("two-up",a);this.$("#spine-divider").toggle(a)},showCurrentPages:function(){var a=
this,b=this.model.get("two_up");this.$(".page-wrap").each(function(c){b||(c+=1);$(this).toggleClass("hidden-page",!a.pages.isPageVisible(c))})},destruct:function(){this.pages.off("change:current_page",this.showCurrentPages);this.model.off("change:display_page_numbers",this.pageNumberCallback,this);this.model.off("change:font_face",this.fontFaceCallback);this.model.off("change:font_size",this.fontSizeCallback);this.resetEl()},linkClickHandler:function(a){a.preventDefault();a=$(a.currentTarget).attr("href");
a.match(/^http(s)?:/)?window.open(a):(this.model.goToHref(a),a=BookshareUtils.getSplitUrl(a),a[1]&&BookshareUtils.setFocus(a[2]))},getBindings:function(){var a=this.model.epub.getPackageDocument();return a.get("bindings").map(function(b){b.selector='object[type="'+b.media_type+'"]';b.url=a.getManifestItemById(b.handler).get("href");b.url=a.resolveUri(b.url);return b})},applyBindings:function(a){for(var b=this,c=this.getBindings(),d=0,d=0;d<c.length;d++)$(c[d].selector,a).each(function(){var a=[],
f=$(this),e=f.attr("data");a.push("src="+b.model.packageDocument.resolveUri(e));a.push("type="+c[d].media_type);a=c[d].url+"?"+a.join("&");e=$(b.bindingTemplate({}));e.attr("src",a);f.html(e)})},applyTriggers:function(a,b){for(var c=0;c<b.length;c++)b[c].subscribe(a)},parseTriggers:function(a){var b=[];$("trigger",a).each(function(){b.push(new Readium.Models.Trigger(this))});return b},applySwitches:function(a){$("switch",a).each(function(){var a=!1;$("case",this).each(function(){var c;if(c=!a)(c=
this.attributes["required-namespace"])?c=_.include(["http://www.w3.org/1998/Math/MathML"],c):(console.log("Encountered a case statement with no required-namespace"),c=!1);c?a=!0:$(this).remove()});a&&$("default",this).remove()})},addSwipeHandlers:function(a){var b=this;$(a).on("swipeleft",function(a){a.preventDefault();b.pages.goRight()});$(a).on("swiperight",function(a){a.preventDefault();b.pages.goLeft()})},togglePageNumbers:function(){var a=this;$(this.getBody()).find(".bksPageNumber").each(function(b,
c){if(a.model.get("display_page_numbers"))c.textContent=c.getAttribute("title"),$(c).addClass("bksPageNumberOn");else{for(;c.hasChildNodes();)c.removeChild(c.childNodes[0]);$(c).removeClass("bksPageNumberOn")}})},highlightThemes:{"default":".ttsImgHL { background-color: #3366AA; opacity: 0.5; z-index: 4242;}\n.ttsSentHL { background-color: #DDDDDD; z-index: -2; }\n.ttsWordHL { background-color: #99CCFF; z-index: -1;}",night:".ttsImgHL { background-color: #3366AA; opacity: 0.5; z-index: 4242;}\n.ttsSentHL { background-color: #B0C6F5; z-index: -2; }\n.ttsWordHL { background-color: #F37D01; z-index: -1;}"},
injectHighlightStyles:function(a){var b;b=a.contentDocument;if(a=b.getElementsByTagName("head")[0]){var c=$(a).find("#highlightStyle");c.length>0&&$(c.remove());b=b.createElement("style");$(b).attr("id","highlightStyle");b.type="text/css";var c=this.model.get("current_theme"),d=this.model.get("beeline_theme");b.innerHTML=c=="night-theme"||d=="night_gray"?this.highlightThemes.night:this.highlightThemes["default"];a.appendChild(b)}},injectPageNumberStyles:function(a){var b;b=a.contentDocument;if(a=
b.getElementsByTagName("head")[0])b=b.createElement("style"),b.type="text/css",b.innerHTML=".bksPageNumberOn { display:block; text-align: center; width: 25%; margin-left: auto; margin-right: auto; font-weight: bold; font-style: italic; border: 1px solid gray; }",a.appendChild(b)},injectLinkHandler:function(a){var b=this;$("a",a.contentDocument).click(function(a){b.linkClickHandler(a)})},injectKeyboardSupport:function(a){var b=this;$(a.contentDocument).keydown(function(a){a.which==39&&b.model.paginator.v.pages.goRight();
a.which==37&&b.model.paginator.v.pages.goLeft()});a=$(b.getBody()).find("body");a.append($(b.shortcutTemplate({ttsEnabled:window.chrome&&window.chrome.extension})));a.find("#hiddenAccessKeys a[accesskey]").bind("click",function(a){a.preventDefault();a=$(window.document.body).find("a[accesskey='"+a.currentTarget.getAttribute("accesskey")+"']");a.attr("href").search("#")==0?a.click():window.document.location=a.attr("href")})},injectTheme:function(){var a=this.model.get("current_theme"),b=this.model.get("beeline_theme"),
c=this.model.get("beeline_object");a==="default"&&(a="default-theme");a!="beeline-theme"?(this.$el.find("link#beeLineStyle").remove(),c&&c.uncolor()):c&&c.recolor();c=this.themes[a].color;a=="beeline-theme"&&b=="night_gray"&&(c="#FFFFFF");$(this.getBody()).css({color:c,"background-color":this.themes[a]["background-color"]});$("#flowing-wrapper").css("visibility","hidden");this.activateEPubStyle(this.getBody());this.injectHighlightStyles(this.getFrame());var d=this.model.options;setTimeout(function(){$("#flowing-wrapper").css("visibility",
"visible");BookshareUtils.beelineNotification(d)},100)},commonBeelineLogic:function(a){var b=this.model.get("current_theme");a.find("link#beeLineStyle").remove();this.$el.find('style[id^="beeline-custom-styles-"]').remove();console.log("commonBeelineLogic theme: "+b);b=="beeline-theme"&&(b=this.model.get("beeline_theme"),a.find("head").append('<link id="beeLineStyle" rel="stylesheet" type="text/css" href="/lib/beeline.min.css"/>'),(a=this.model.get("beeline_object"))&&a.cleanup(),console.log("New Beeline object with theme "+
b),a=new BeeLineReader($(this.getBody()).get(0),{theme:b,skipBackgroundColor:!1,colorImmediately:!0,handleResize:!0}),a.color(),this.model.set("beeline_object",a))},themes:{"default-theme":{"background-color":"white",color:"black","mo-color":"#777"},"parchment-theme":{"background-color":"#f7f1cf",color:"#774c27","mo-color":"#eebb22"},"night-theme":{"background-color":"#141414",color:"white","mo-color":"#666"},"beeline-theme":{"background-color":"white",color:"000000","mo-color":"#777"}},resetEl:function(){$("body").removeClass("apple-fixed-layout");
$("#readium-book-view-el").attr("style","");this.$el.toggleClass("two-up",!1);this.$("#spine-divider").toggle(!1);this.zoomer.reset();$("#page-wrap").css({position:"relative",right:"0px",top:"0px","-webkit-transform":"scale(1.0) translate(0px, 0px)"})}});
Readium.Views.InjectedReflowablePaginationView=Readium.Views.PaginationViewBase.extend({initialize:function(a){Readium.Views.PaginationViewBase.prototype.initialize.call(this,a);this.page_template=Handlebars.templates.injected_reflowing_template;this.stashModernizrPrefixedProps();this.offset_dir=this.model.epub.get("page_prog_dir")==="rtl"?"right":"left";this.trackPosition=!0;this.pages.on("change:current_page",this.pageChangeHandler,this);this.model.on("change:toc_visible",this.windowSizeChangeHandler,
this);this.model.on("repagination_event",this.windowSizeChangeHandler,this);this.model.on("change:current_theme",this.injectTheme,this);this.model.on("change:two_up",this.setUpMode,this);this.model.on("change:two_up",this.windowSizeChangeHandler,this);this.model.on("change:current_margin",this.marginCallback,this);this.model.on("change:beeline_theme",this.injectTheme,this);this.model.on("change:beeline_theme",this.beeLineCallback,this)},render:function(a,b){var c=this;this.model.getCurrentSection().content==
null?(BookshareUtils.raiseSystemAlert("loading_content"),this.model.getCurrentSection().fetch({success:function(){BookshareUtils.dismissSystemAlert();c.renderInternal(a,b)}})):this.renderInternal(a,b);return[this.model.get("spine_position")]},renderInternal:function(a,b){var c=this,f=this.model.getCurrentSection().toJSON(),e=this.model.getCurrentSection().content;this.setUpMode();this.$("#container").html(this.page_template(f));this.$("#readium-flowing-content").on("load",function(d){if(!d.srcElement)d.srcElement=
this;d.srcElement.contentDocument.documentElement.appendChild(e.children[0].cloneNode(!0));d.srcElement.contentDocument.documentElement.appendChild(e.children[1].cloneNode(!0));c.adjustIframeColumns();c.iframeLoadCallback(d);c.setFontSize();c.setFontFace();c.injectTheme();c.setBeeLine();c.setNumPages();c.disableFocusAutoscroll();b?c.goToHashFragment(b):a?c.pages.goToLastPage():c.model.get("reading_position")!=null?c.goToReadingPosition():(c.pages.goToPage(1),c.goToPage(1))})},findVisiblePageElements:function(){var a=
$(this.getBody()).find("[id]"),b=$("#readium-flowing-content").contents()[0].documentElement,c=0+$(b).width(),b=0+$(b).height();return this.filterElementsByPosition(a,0,b,0,c)},filterElementsByPosition:function(a,b,c,f,e){return a.filter(function(){var a=$(this).offset().top,g=$(this).offset().left,h=g+$(this).width(),i=a+$(this).height(),a=a>=b&&i<=c;return g>=f&&h<=e&&a})},destruct:function(){this.hideContent();this.pages.off("change:current_page",this.pageChangeHandler);this.model.off("change:toc_visible",
this.windowSizeChangeHandler);this.model.off("repagination_event",this.windowSizeChangeHandler);this.model.off("change:current_theme",this.injectTheme);this.model.off("change:two_up",this.setUpMode);this.model.off("change:two_up",this.windowSizeChangeHandler);this.model.off("change:current_margin",this.marginCallback);this.model.off("change:beeline_theme",this.injectTheme);this.model.off("change:beeline_theme",this.beeLineCallback);Readium.Views.PaginationViewBase.prototype.destruct.call(this)},goToPage:function(a){a=
this.calcPageOffset(a).toString()+"px";$(this.getBody()).css(this.offset_dir,"-"+a);this.showContent();this.trackPosition&&this.model.get("track_position")&&BookshareUtils.findTopElement(this)&&this.model.set("reading_position",BookshareUtils.getSelectorForNearestElementWithId(BookshareUtils.findTopElement(this)))},goToHashFragment:function(a){if(a&&(a=$("#"+a,this.getBody())[0])){for(;a.children.length>0;)a=a.children[0];var b=this.getElemPageNumber(a);this.trackPosition&&this.model.get("track_position")&&
this.model.set("reading_position",BookshareUtils.getSelectorForNearestElementWithId(a));if(b>0)this.trackPosition=!1,this.pages.goToPage(b),this.goToPage(b),this.trackPosition=!0}},setFontSize:function(){var a=this.model.get("font_size")/10;$(this.getBody()).css("font-size",a+"em");this.setNumPages()},setFontFace:function(){var a=this.model.get("font_face");this.$("#readium-flowing-content").contents().find("link#fontStyle").remove();a=="OpenDyslexic"&&this.$("#readium-flowing-content").contents().find("head").append('<link id="fontStyle" rel="stylesheet" type="text/css" href="/fonts/OpenDyslexic/OpenDyslexic.css"/>');
$(this.getBody()).css("font-family",a);this.setNumPages()},setBeeLine:function(){this.commonBeelineLogic(this.$("#readium-flowing-content").contents())},stashModernizrPrefixedProps:function(){var a=function(a){return a.replace(/([A-Z])/g,function(a,b){return"-"+b.toLowerCase()}).replace(/^ms-/,"-ms-")};this.columAxis=Modernizr.prefixed("columnAxis")||"columnAxis";this.columGap=Modernizr.prefixed("columnGap")||"columnGap";this.columWidth=Modernizr.prefixed("columnWidth")||"columnWidth";this.cssColumAxis=
a(this.columAxis);this.cssColumGap=a(this.columGap);this.cssColumWidth=a(this.columWidth)},getBodyColumnCss:function(){var a={};a[this.cssColumAxis]="horizontal";a[this.cssColumGap]=this.gap_width.toString()+"px";a[this.cssColumWidth]=this.page_width.toString()+"px";a.padding="0px";a.margin="0px";a.position="absolute";a.width=this.page_width.toString()+"px";a.height=this.frame_height.toString()+"px";return a},adjustIframeColumns:function(){var a=this.$("#readium-flowing-content");this.setFrameSize();
this.frame_width=parseInt(a.width(),10);this.frame_height=parseInt(a.height(),10);this.gap_width=Math.floor(this.frame_width/7);this.page_width=this.model.get("two_up")?Math.floor((this.frame_width-this.gap_width)/2):this.frame_width;$(this.getBody()).css(this.getBodyColumnCss());this.setNumPages()},getBody:function(){return this.$("#readium-flowing-content").contents()[0].documentElement},getFrame:function(){return this.$("#readium-flowing-content")[0]},hideContent:function(){$("#flowing-wrapper").css("opacity",
"0")},showContent:function(){$("#flowing-wrapper").css("opacity","1")},calcPageOffset:function(a){return(a-1)*(this.page_width+this.gap_width)},setFrameSize:function(){var a=this.getFrameWidth().toString()+"px",b=this.getFrameHeight().toString()+"px";this.$("#readium-flowing-content").attr("width",a);this.$("#readium-flowing-content").attr("height",b);this.$("#readium-flowing-content").css("width",a);this.$("#readium-flowing-content").css("height",b)},getFrameWidth:function(){var a,b=this.model.get("current_margin");
b===1?this.model.get("two_up")?a=0.95:a=0.9:b===2?this.model.get("two_up")?a=0.89:a=0.8:b===3?this.model.get("two_up")?a=0.83:a=0.7:b===4?this.model.get("two_up")?a=0.77:a=0.6:this.model.get("two_up")?a=0.7:a=0.5;return Math.floor($("#flowing-wrapper").width()*a)},getFrameHeight:function(){return $("#flowing-wrapper").height()},calcNumPages:function(){var a,b,c;a=this.getBody();if(!a)return this.pages.get("num_pages");b=a.style[this.offset_dir];a.style[this.offset_dir]="0px";c=this.getBody().scrollWidth;
a.style[this.offset_dir]=b;a=Math.floor((c+this.gap_width)/(this.gap_width+this.page_width));a%2===0&&this.model.get("two_up");return a},getElemPageNumber:function(a){var b,a=a.getClientRects();if(!a||a.length<1)return-1;b=a[0][this.offset_dir];b+=Math.abs(a[0].left-a[0].right);this.offset_dir==="right"&&(b=this.page_width-b);b-=parseInt(this.getBody().style[this.offset_dir]||0,10);return Math.ceil(b/(this.page_width+this.gap_width))},getElemPageNumberById:function(a){var b=$("#readium-flowing-content").contents()[0].documentElement,
a=$(b).find("#"+a);return a.length==0?-1:this.getElemPageNumber(a[0])},pageChangeHandler:function(){var a=this;this.trackPosition&&(this.hideContent(),setTimeout(function(){a.goToPage(a.pages.get("current_page")[0])},150))},goToReadingPosition:function(){var a=this.pages.get("current_page")[0]||1,b=$(this.getBody()).find(this.model.get("reading_position"));b.length>0&&(b=this.getElemPageNumber(b[0]),!isNaN(b)&&b>0&&(a=b));this.trackPosition=!1;this.pages.goToPage(a);this.goToPage(a);this.trackPosition=
!0},windowSizeChangeHandler:function(){this.adjustIframeColumns();this.goToReadingPosition()},marginCallback:function(){this.adjustIframeColumns();this.goToReadingPosition()},pageNumberCallback:function(){this.togglePageNumbers();this.adjustIframeColumns();this.goToReadingPosition()},fontSizeCallback:function(){this.setFontSize();this.goToReadingPosition()},fontFaceCallback:function(){this.setFontFace();this.goToReadingPosition()},beeLineCallback:function(){this.setBeeLine();this.goToReadingPosition()},
setNumPages:function(){this.pages.set("num_pages",this.calcNumPages())},disableFocusAutoscroll:function(){var a=$(this.getBody()),b=a.find("body");b.find("a[href]").focus(function(){a.scrollLeft(0);setTimeout(function(){b.scrollLeft(0)},0)})}});
Readium.Views.InjectedScrollingPaginationView=Readium.Views.PaginationViewBase.extend({initialize:function(a){Readium.Views.PaginationViewBase.prototype.initialize.call(this,a);this.page_template=Handlebars.templates.injected_scrolling_page_template;this.offset_dir=this.model.epub.get("page_prog_dir")==="rtl"?"right":"left";this.trackScrolling=!0;this.model.on("change:toc_visible",this.windowSizeChangeHandler,this);this.model.on("repagination_event",this.windowSizeChangeHandler,this);this.model.on("change:current_theme",
this.injectTheme,this);this.model.on("change:current_margin",this.marginCallback,this);this.model.on("change:beeline_theme",this.injectTheme,this);this.model.on("change:beeline_theme",this.beeLineCallback,this)},render:function(a,c){var b=this;this.model.getCurrentSection().content==null?(BookshareUtils.raiseSystemAlert("loading_content"),this.model.getCurrentSection().fetch({success:function(){BookshareUtils.dismissSystemAlert();b.renderInternal(a,c)}})):this.renderInternal(a,c);return[this.model.get("spine_position")]},
renderInternal:function(a,c){var b=this,e=this.model.getCurrentSection().toJSON(),f=this.model.getCurrentSection().content;this.$("#container").html(this.page_template(e));this.$("#readium-scrolling-content").on("load",function(d){if(!d.srcElement)d.srcElement=this;d.srcElement.contentDocument.documentElement.appendChild(f.children[0].cloneNode(!0));d.srcElement.contentDocument.documentElement.appendChild(f.children[1].cloneNode(!0));b.adjustIframe();b.iframeLoadCallback(d);b.setFontSize();b.setFontFace();
b.injectTheme();b.setBeeLine();b.getFrame().contentWindow.onscroll=b.makeScrollHandler();setTimeout(function(){c?b.goToHashFragment(c):(b.getFrame().focus(),a?b.getFrame().contentWindow.scrollBy(0,b.getBody().scrollHeight):b.model.get("reading_position")!=null?b.goToReadingPosition():(b.getFrame().contentWindow.scrollTo(0,0),b.getFrame().contentWindow.onscroll()))},250)})},getBody:function(){return this.$("#readium-scrolling-content").contents()[0].documentElement},getFrame:function(){return this.$("#readium-scrolling-content")[0]},
setFontSize:function(){var a=this.model.get("font_size")/10;$(this.getBody()).css("font-size",a+"em")},setFontFace:function(){var a=this.model.get("font_face");this.$("#readium-scrolling-content").contents().find("link#fontStyle").remove();a=="OpenDyslexic"&&this.$("#readium-scrolling-content").contents().find("head").append('<link id="fontStyle" rel="stylesheet" type="text/css" href="/fonts/OpenDyslexic/OpenDyslexic.css"/>');$(this.getBody()).css("font-family",a)},setBeeLine:function(){this.commonBeelineLogic(this.$("#readium-scrolling-content").contents())},
adjustIframe:function(){this.$("#readium-scrolling-content");this.setFrameSize()},setFrameSize:function(){var a=this.getFrameWidth().toString()+"px",c=this.getFrameHeight().toString()+"px";this.$("#readium-scrolling-content").attr("width",a);this.$("#readium-scrolling-content").attr("height",c);this.$("#readium-scrolling-content").css("width",a);this.$("#readium-scrolling-content").css("height",c);this.getBody().style.overflowX="hidden"},getFrameWidth:function(){var a;switch(this.model.get("current_margin")){case 1:a=
0.9;break;case 2:a=0.8;break;case 3:a=0.7;break;case 4:a=0.6;break;default:a=0.5}return Math.floor($("#scrolling-wrapper").width()*a)},getFrameHeight:function(){return $("#scrolling-wrapper").height()},windowSizeChangeHandler:function(){this.adjustIframe();this.goToReadingPosition()},marginCallback:function(){this.adjustIframe();this.goToReadingPosition()},pageNumberCallback:function(){this.togglePageNumbers();this.goToReadingPosition()},fontSizeCallback:function(){this.setFontSize();this.goToReadingPosition()},
fontFaceCallback:function(){this.setFontFace();this.goToReadingPosition()},beeLineCallback:function(){this.setBeeLine();this.goToReadingPosition()},goToHashFragment:function(a){var c=this.getFrame();c.focus();c.contentDocument.location.hash=a},keepInCenter:function(a){var c=this.getFrame(),b=this.getFrameHeight(),e=Number(a.style.top.replace("px",""));a.style.height.replace("px","");c.contentWindow.scrollTo(0,e-Math.round(0.25*b))},goToReadingPosition:function(){if(this.model.get("reading_position")!=
null){var a=$(this.getBody()).find(this.model.get("reading_position"));if(a.length>0)this.trackScrolling=!1,this.getFrame().contentWindow.scrollBy(0,a[0].getClientRects()[0].top),this.trackScrolling=!0}},makeScrollHandler:function(){var a=this;return function(){if(a.trackScrolling&&a.model.get("track_position")){var c=BookshareUtils.findTopElement(a,0.3);a.model.set("reading_position",BookshareUtils.getSelectorForNearestElementWithId(c))}}},destruct:function(){this.model.off("change:toc_visible",
this.windowSizeChangeHandler);this.model.off("repagination_event",this.windowSizeChangeHandler);this.model.off("change:current_theme",this.injectTheme);this.model.off("change:current_margin",this.marginCallback);this.model.off("change:beeline_theme",this.injectTheme);this.model.off("change:beeline_theme",this.beeLineCallback);this.getFrame().contentWindow.onscroll=null;Readium.Views.PaginationViewBase.prototype.destruct.call(this)}});
Readium.Views.ToolbarView=Backbone.View.extend({el:"#toolbar-el",initialize:function(){this.model.set("toolbar_visible",Readium.Utils.getCookie("toolbar_visible")!=="false");this.model.on("change:toolbar_visible",this.renderBarVibility,this);this.model.on("change:full_screen",this.renderFullScreen,this);this.model.on("change:current_theme",this.renderThemeButton,this);if(this.hasTts=BookshareUtils.hasSpeechAPI())this.model.ttsPlayer.on("change:tts_playing",this.renderTtsButton,this)},render:function(){this.renderBarVibility();
this.renderFullScreen();this.renderThemeButton();this.renderTtsButton();return this},renderBarVibility:function(){var a=this.model.get("toolbar_visible");this.$("#show-toolbar-button").toggle(!a);this.$("#top-bar").toggle(a);return this},renderFullScreen:function(){if(this.model.get("supports_full_screen")){var a=this.model.get("full_screen");this.$("#go-to-fs-ico").toggle(!a);this.$("#leave-fs-ico").toggle(a);$("#fs-toggle-btn").attr("title",a?"Fullscreen on":"Fullscreen off");$("#fsOT").html(a?
"Fullscreen on":"Fullscreen off")}else this.$("#go-to-fs-ico").toggle(!1),this.$("#leave-fs-ico").toggle(!1),this.$("#fs-toggle-btn").toggle(!1);return this},renderThemeButton:function(){var a=this.model.get("current_theme")==="night-theme";this.$("#night-to-day-ico").toggle(a);this.$("#day-to-night-ico").toggle(!a);$("#nightmode-btn").attr("title",a?"Nightmode on":"Nightmode off");$("#nmOT").html(a?"Nightmode on":"Nightmode off");return this},renderTtsButton:function(){var a=!!this.model.ttsPlayer&&
this.model.ttsPlayer.get("tts_playing");this.$("#tts-on-ico").toggle(a);this.$("#tts-off-ico").toggle(!a);$("#play-tts-btn").attr("title",a?"Stop":"Play");$("#ttsOT").html(a?"Play":"Stop");return this},events:{"click #hide-toolbar-button":"hide_toolbar","click #show-toolbar-button":"show_toolbar","click #fs-toggle-btn":"toggle_fs","click #toggle-toc-btn":"toggle_toc","click #nightmode-btn":"toggle_night_mode","click #play-tts-btn":"play_tts"},show_toolbar:function(a){a.preventDefault();Readium.Utils.setCookie("toolbar_visible",
!0,365);this.model.set("toolbar_visible",!0)},hide_toolbar:function(a){a.preventDefault();Readium.Utils.setCookie("toolbar_visible",!1,365);this.model.set("toolbar_visible",!1)},toggle_fs:function(a){a.preventDefault();this.model.toggleFullScreen()},toggle_toc:function(a){a.preventDefault();this.model.toggleToc()},toggle_night_mode:function(){this.model.get("current_theme")==="night-theme"?this.model.get("day_theme")?(this.model.set("current_theme",this.model.get("day_theme")),Readium.Utils.setCookie("current_theme",
this.model.get("day_theme"),365)):(this.model.set("current_theme","default-theme"),Readium.Utils.setCookie("current_theme","default-theme",365)):(this.model.set("day_theme",this.model.get("current_theme")),this.model.set("current_theme","night-theme"),Readium.Utils.setCookie("current_theme","night-theme",365))},play_tts:function(){if(this.hasTts&&!BookshareUtils.isEdge()&&!BookshareUtils.isFirefox())this.model.ttsPlayer.get("tts_playing")?this.model.ttsPlayer.stop():this.model.ttsPlayer.play();else{var a=
"To read books aloud with text-to-speech and synchronized highlighting, please use the latest version of Google Chrome or Apple Safari on a computer. You can also read text aloud with a screen reader.";BookshareUtils.isIOS()?a="This browser does not support text-to-speech with synchronized highlighting, but you can use VoiceOver to have the contents of the book of the book read aloud.":BookshareUtils.isEdge()?a="We are awaiting updates from Microsoft that will support text-to-speech with synchronized highlighting in this browser. Until then, please use the latest version of Google Chrome or Apple Safari on a computer or you can also read text aloud with a screen reader.":
BookshareUtils.isFirefox()?a="To read books aloud with text-to-speech and synchronized highlighting, please use the latest version of Google Chrome or Apple Safari on a computer. You can also read text aloud with a screen reader.":BookshareUtils.isAndroidOrWindowsPhone()&&(a="This browser does not support text-to-speech with synchronized highlighting, but you can use TalkBack to have the contents of the book of the book read aloud.");$("#tts-browser-info .modal-body p").text(a);$("#tts-browser-info").modal("show")}}});
Readium.Views.TocViewBase=Backbone.View.extend({el:"#readium-toc",initialize:function(){this.model.on("change",this.render,this);this.model.on("change:visible",this.setVisibility,this)},events:{"click a":"handleClick","click #close-toc-button":"closeToc","keyup #close-toc-button":"closeToc"},setVisibility:function(){this.$el.toggle(this.model.get("visible"))},handleClick:function(a){a.preventDefault();href=$(a.currentTarget).attr("href");this.model.hide();this.model.handleLink(href);a=BookshareUtils.getSplitUrl(href);
a[1]&&BookshareUtils.setFocus(a[2])},handlePageSelect:function(a){a=a.target[a.target.selectedIndex].value;this.model.hide();this.model.handleLink(a);a=BookshareUtils.getSplitUrl(a);a[1]&&BookshareUtils.setFocus(a[2])},closeToc:function(a){if(a.type=="click"||a.type=="keyup"&&a.keyCode==13)a.preventDefault(),this.model.hide()},scrollToNavItem:function(a){var b=a.getClientRects()[0].top,a=this.$("#toc-body");b+=this.$("#toc-header").height();a.scrollTop(a.scrollTop()+b-Math.ceil(a.height()*0.4))}});
Readium.Views.NcxTocView=Readium.Views.TocViewBase.extend({initialize:function(){Readium.Views.TocViewBase.prototype.initialize.call(this);this.nav_template=Handlebars.templates.ncx_nav_template},render:function(){this.setVisibility();for(var a=$("<ol></ol>"),b=this.model.get("navs"),c=0;c<b.length;c++)a.append(this.nav_template(b[c]));this.$("#toc-body").html("<h1 tabindex='-1' id='toc-heading-ref'>"+(this.model.get("title")||"Table of Contents")+"</h1>");this.$("#toc-body").append(a);this.$("#toc-body").append("<div id='toc-end-spacer'>");
return this}});
Readium.Views.XhtmlTocView=Readium.Views.TocViewBase.extend({events:{"click a":"handleClick","click #close-toc-button":"closeToc","keyup #close-toc-button":"closeToc","change #toc-page-select":"handlePageSelect"},render:function(){this.$("#toc-body").html(this.model.get("body").html());this.formatPageListNavigation();this.$("#toc-body").append("<div id='toc-end-spacer'>");this.model.get("visible")&&this.renderTocHighlight();return this},renderTocHighlight:function(){var a=this.model.get("toc_highlight_selector");a&&
this.scrollToNavItem(this.$("#toc-body").find(a).addClass("tocHighlight")[0])},formatPageListNavigation:function(){var a,b;a=this.$("nav").filter(function(){if($(this).attr("epub:type")==="page-list")return $(this).attr("id","page-list-select"),$(this).hide(),!0});b=$("#toc-page-select");a=a.find("a").not(":empty");b.length==0&&a.length!=0&&(b=$("<select id='toc-page-select'></select>"),$("#toc-page-nav").prepend(b).prepend("<label for='toc-page-select'>Go to page:</label> "),b.append($("<option/>",
{disabled:!0,selected:!0})),a.each(function(){var a=$(this);b.append($("<option/>",{value:a.attr("href"),text:a.text()}))}))}});
Readium.Views.OptionsView=Backbone.View.extend({el:"#viewer-settings-modal",DEFAULT_VOICES:["Alex","native"],initialize:function(){console.log("Initializing options menu.");this.model.on("change:current_margin",this.renderMarginRadio,this);this.model.on("change:current_theme",this.renderTheme,this);var a=this;this.model.get("controller").get("columns_supported")||($("#setting-header-display-legend").toggle(!1),$("#pagination_mode").toggle(!1));this.model.get("controller").get("isIosDevice")&&$("#scrolling-option").toggle(!1);
$(".ttsOnly").toggle(BookshareUtils.hasSpeechAPI()||!!window.chrome&&!!window.chrome.tts);Acc.rg={theme:new Acc.RadioGroup("theme-radio-group"," ."+this.model.get("current_theme"),function(b){b=b.id;b==="default-theme-option"&&a.model.set("current_theme","default-theme");b==="night-theme-option"&&a.model.set("current_theme","night-theme");b==="parchment-theme-option"&&a.model.set("current_theme","parchment-theme");b==="beeline-theme-option"&&a.model.set("current_theme","beeline-theme")}),margin:new Acc.RadioGroup("margin-radio-wrapper",
" #margin-option-"+this.model.get("current_margin"),function(b){b=b.id;b=b[b.length-1];b==="1"&&a.model.set("current_margin",1);b==="2"&&a.model.set("current_margin",2);b==="3"&&a.model.set("current_margin",3);b==="4"&&a.model.set("current_margin",4);b==="5"&&a.model.set("current_margin",5)})};$("#options-btn").attr("aria-pressed","false");$("#viewer-settings-modal").on("show",function(){a.render()});$("#viewer-settings-modal").on("shown",function(){a.model.get("controller").set("options-view-shown",
!0);$("#options-heading").focus();setTimeout(function(){$("#options-btn").attr("aria-pressed","true")},1)}).on("hidden",function(){a.model.get("controller").set("options-view-shown",!1);setTimeout(function(){$("#options-btn").attr("aria-pressed","false").focus()},1)})},renderBeelineOption:function(){var a=this.model.get("beeline_theme");$("ul#beeline-beta-menu li").removeClass("active");$("li#"+a+"-button").addClass("active")},render:function(){this.renderPagination();this.renderTheme();this.renderBeelineOption();
this.renderMarginRadio();this.renderFontSize();this.renderFontFace();this.renderDisplayPageNumbers();if(BookshareUtils.hasSpeechAPI()&&(this.renderSpeechRate(),this.renderVoiceOptions(),window.chrome))speechSynthesis.onvoiceschanged=_.bind(this.renderVoiceOptions,this);return this},renderTheme:function(){var a=this.model.get("current_theme");this.$("#default-theme-option").toggleClass("selected",a=="default-theme");this.$("#night-theme-option").toggleClass("selected",a=="night-theme");this.$("#parchment-theme-option").toggleClass("selected",
a=="parchment-theme");this.$("#beeline-theme-option").toggleClass("selected",a=="beeline-theme");return this},renderMarginRadio:function(){var a="#margin-option-"+this.model.get("current_margin");this.$(".margin-radio").toggleClass("selected",!1);this.$(a).toggleClass("selected",!0);return this},renderFontSize:function(){var a=this.model.get("font_size");this.$("#font-size-input").val(a)},renderFontFace:function(){var a=this.model.get("font_face");this.$("#font-face-input").val(a)},renderPagination:function(){var a=
this.model.get("pagination_mode");this.$("#pagination-mode-input").val(a)},filterVoiceOptions:function(a){return a.localService&&(a.name=="US English Female TTS (by Google)"||!/google/i.test(a.voiceURI))},renderVoiceOptions:function(){var a,b=$("#voice-input");b.children().remove();var c=speechSynthesis.getVoices().filter(this.filterVoiceOptions);for(i=0;i<c.length;i++){var d=c[i],e=$("<option>").text(d.name).val(d.voiceURI);b.append(e);if(i==0||this.DEFAULT_VOICES.indexOf(d.name)>=0)a=d.voiceURI}c=
b.find("option[value='"+a+"']");c.text(c.text()+" (default)");c=this.model.get("voice_uri");b.val(c?c:a);a=this.model.get("controller");a.set("voice_uri",b.val());a.trigger("change:voice_uri")},renderSpeechRate:function(){var a=this.model.get("speech_rate");this.$("#speech-rate-input").val(a)},renderDisplayPageNumbers:function(){this.$("#display-page-numbers").prop("checked",this.model.get("display_page_numbers"))},events:{"click .theme-option":"selectTheme","click .margin-radio":"selectMargin","click #cancel-settings-but":"cancelSettings",
"click #save-settings-but":"applySettings","click #bright-button":function(){this.selectBeelineTheme("bright")},"click #dark-button":function(){this.selectBeelineTheme("dark")},"click #blues-button":function(){this.selectBeelineTheme("blues")},"click #gray-button":function(){this.selectBeelineTheme("gray")},"click #night_gray-button":function(){this.selectBeelineTheme("night_gray")}},selectBeelineTheme:function(a){a=="gray"&&console.log("Selecting gray theme.");this.model.set("current_theme","beeline-theme");
this.model.set("beeline_theme",a);this.renderTheme();this.renderBeelineOption()},unselectAllBeelineThemes:function(){$("#beeline-beta-menu li").each(function(){$(this).removeClass("active")})},selectTheme:function(a){var b=a.srcElement?a.srcElement.id:"";b&&a.srcElement&&Acc.rg&&Acc.rg.theme&&a.srcElement!=Acc.rg.theme.selected&&Acc.rg.theme.set(b);b==="default-theme-option"&&(this.model.set("current_theme","default-theme"),this.unselectAllBeelineThemes(),this.model.set("beeline_theme",""));b==="night-theme-option"&&
(this.model.set("current_theme","night-theme"),this.unselectAllBeelineThemes(),this.model.set("beeline_theme",""));b==="parchment-theme-option"&&(this.model.set("current_theme","parchment-theme"),this.unselectAllBeelineThemes(),this.model.set("beeline_theme",""));b==="beeline-theme-option"&&(this.model.set("current_theme","beeline-theme"),this.selectBeelineTheme("bright"));a.stopPropagation()},selectMargin:function(a){var b=a.srcElement.id;a.srcElement&&Acc.rg&&Acc.rg.margin&&a.srcElement!=Acc.rg.margin.selected&&
Acc.rg.margin.set(b);b=b[b.length-1];b==="1"&&this.model.set("current_margin",1);b==="2"&&this.model.set("current_margin",2);b==="3"&&this.model.set("current_margin",3);b==="4"&&this.model.set("current_margin",4);b==="5"&&this.model.set("current_margin",5);a.stopPropagation()},cancelSettings:function(){this.$el.modal("hide");this.model.resetOptions();$("#options-btn").focus()},applySettings:function(){this.model.set("display_page_numbers",this.$("#display-page-numbers").prop("checked"));this.model.set("pagination_mode",
$("#pagination-mode-input").val());this.model.set("font_size",parseInt($("#font-size-input").val(),10));this.model.set("font_face",$("#font-face-input").val());this.model.set("speech_rate",parseFloat($("#speech-rate-input").val()));this.model.set("voice_uri",$("#voice-input").val());this.model.applyOptions();this.$el.modal("hide");$("#options-btn").focus()}});
Readium.Views.HelpView=Backbone.View.extend({el:"#viewer-help-modal",initialize:function(){console.log("Initializing Help Modal.");$("#help-btn").attr("aria-pressed","false");$("#viewer-help-modal").on("shown",function(){$("#help-heading").focus();setTimeout(function(){$("#help-btn").attr("aria-pressed","true")},1)}).on("hidden",function(){setTimeout(function(){$("#help-btn").attr("aria-pressed","false").focus()},1)})},events:{"click #cancel-help-but":"cancelHelp"},render:function(){return this},
cancelHelp:function(){this.$el.modal("hide");$("#help-btn").focus()}});
Readium.Views.FixedLayoutBookZoomer=Backbone.View.extend({el:"#readium-right-content",horizontalPad:30,verticalPad:30,initialize:function(){this.zoomingModel=new Readium.Models.FixedLayoutBookZoomingModel},render:function(){this.$("#page-wrap").css(this.zoomingModel.getCSSProperties());return this},reset:function(){this.zoomingModel.setDefaults();this.render()},fitToBest:function(){var a=this.fitToWidthScale(),b=this.fitToHeightScale();a<b?this.applyScale(a):this.applyScale(b)},fitToWidth:function(){this.applyScale(this.fitToWidthScale())},
fitToHeight:function(){this.applyScale(this.fitToHeightScale())},fitToWidthScale:function(){return(this.containerWidth()-this.horizontalPad)/this.bookWidth()},fitToHeightScale:function(){return(this.containerHeight()-this.verticalPad)/this.bookHeight()},applyScale:function(a){this.zoomingModel.set("scale",a);this.zoomingModel.set("leftShift",this.leftShift(a));this.zoomingModel.set("topShift",this.verticalPad/2);this.render()},leftShift:function(a){return(this.containerWidth()-this.bookWidth()*a)/
2},containerWidth:function(){return this.$el.width()},containerHeight:function(){return this.$el.height()},bookWidth:function(){return this.$("#page-wrap").width()},bookHeight:function(){return this.$("#page-wrap").height()}});
Readium.Models.FixedLayoutBookZoomingModel=Backbone.Model.extend({initialize:function(){this.styleAttrs=this.getModernizedAttrs()},defaults:{scale:1,leftShift:0,topShift:0},setDefaults:function(){this.set(this.defaults)},getModernizedAttrs:function(){var a={};a.transform=this.modernizrCssPrefix("transform");a.transformOrigin=this.modernizrCssPrefix("transformOrigin");return a},modernizrCssPrefix:function(a){return Modernizr.prefixed(a).replace(/([A-Z])/g,function(a,c){return"-"+c.toLowerCase()}).replace(/^ms-/,
"-ms-")},getCSSProperties:function(){var a={};a[this.styleAttrs.transform]=this.getTransformString();a[this.styleAttrs.transformOrigin]="0 0";return a},getTransformString:function(){str="";str+="translate("+this.get("leftShift")+"px, "+this.get("topShift")+"px) ";str+="scale("+this.get("scale").toString()+")";return str}});
Readium.Views.ViewerApplicationView=Backbone.View.extend({el:"body",uiVisible:!1,initialize:function(){for(var a=this,b=0;b<Modernizr._domPrefixes.length;b++)if(document.documentElement[Modernizr._domPrefixes[b]+"RequestFullScreen"]!=null){this.model.set("supports_full_screen",!0);this.requestFullscreen=document.documentElement[Modernizr._domPrefixes[b]+"RequestFullScreen"];this.cancelFullscreen=document[Modernizr._domPrefixes[b]+"CancelFullScreen"];var c=Modernizr._domPrefixes[b];document[c+"FullscreenElement"]!==
void 0?c+="FullscreenElement":document[c+"FullScreenElement"]!==void 0&&(c+="FullScreenElement");this.getFullscreenElement=function(){return document[c]};$(document).bind(Modernizr._domPrefixes[b]+"fullscreenchange",function(){a.getFullscreenElement()==null?a.model.set("full_screen",!1):a.model.set("full_screen",!0)});break}this.model.on("change:full_screen",this.toggleFullscreen,this);this.model.on("change:current_theme",this.renderTheme,this);this.model.on("change:beeline_theme",this.renderTheme,
this);this.model.on("change:toolbar_visible",this.renderPageButtons,this);this.model.on("change:toc_visible",this.renderTocVisible,this);this.optionsView=new Readium.Views.OptionsView({model:this.model.options});this.optionsView.render();this.helpView=new Readium.Views.HelpView({model:_epubController});this.helpView.render();this.toolbar=new Readium.Views.ToolbarView({model:_epubController});this.toolbar.render();this.model.on("change:has_toc",this.init_toc,this);this.addGlobalEventHandlers()},toggleFullscreen:function(){this.model.get("full_screen")?
this.requestFullscreen.call(document.documentElement):this.cancelFullscreen.call(document)},addGlobalEventHandlers:function(){var a=this.model,b=this;window.onresize=function(){a.trigger("repagination_event")};$(document).keydown(function(a){b.allowAccessKey()&&(a.which==39&&b.model.paginator.v.pages.goRight(),a.which==37&&b.model.paginator.v.pages.goLeft())});$("#readium-book-view-el").on("swipeleft",function(a){b.allowAccessKey()&&(a.preventDefault(),b.model.paginator.v.pages.goRight())});$("#readium-book-view-el").on("swiperight",
function(a){b.allowAccessKey()&&(a.preventDefault(),b.model.paginator.v.pages.goLeft())})},allowAccessKey:function(){return $("#viewer-settings-modal").is(":visible")||$("#viewer-help-modal").is(":visible")?!1:!0},render:function(){this.renderTheme();this.renderPageButtons();this.renderTocVisible();return this},renderPageButtons:function(){var a=this.model.get("toolbar_visible");this.$("#prev-page-button").toggle(a);this.$("#next-page-button").toggle(a);return this},renderTheme:function(){var a=this.model.get("current_theme"),
b=this.model.get("beeline_theme"),c=this.model.get("beeline_object");c&&(a=="beeline-theme"?c.recolor():(this.$el.find("link#beeLineStyle").remove(),c.uncolor()));console.log("renderTheme theme in viewer.js: "+a+" beeline_theme: "+b);this.$el.toggleClass("default-theme","default-theme"===a||"beeline-theme"===a&&b!="night_gray");this.$el.toggleClass("night-theme","night-theme"===a||"beeline-theme"===a&&b=="night_gray");this.$el.toggleClass("parchment-theme","parchment-theme"===a);this.$("#readium-book-view-el").toggleClass("default-theme",
"default-theme"===a||"beeline-theme"===a&&b!="night_gray");this.$("#readium-book-view-el").toggleClass("night-theme","night-theme"===a||"beeline-theme"===a&&b=="night_gray");this.$("#readium-book-view-el").toggleClass("parchment-theme","parchment-theme"===a)},renderTocVisible:function(){var a=this.model.get("toc_visible");$("#toggle-toc-btn").attr("aria-pressed",a?"true":"false");this.$el.toggleClass("show-readium-toc",a);var b=this;a&&setTimeout(function(){b.toc.model.updateTocHighlight();b.$el.find(b.toc.model.get("toc_highlight_selector")).focus()},
50);return this},init_toc:function(){if(this.model.get("has_toc")){var a=this.model.getToc();this.toc=a.TocView();a.fetch()}},events:{"click #prev-page-button":function(){this.model.paginator.v.pages.goLeft()},"click #next-page-button":function(){this.model.paginator.v.pages.goRight()}}});
Readium.Routers.ViewerRouter=Backbone.Router.extend({routes:{"viewer.html?book=:key":"openBook","rnibbookshare/viewer.html?book=:key":"openBook","load2learn/viewer.html?book=:key":"openBook","*splat":"splat_handler"},openBook:function(a){var d=this,b={url:BookshareUtils.resolveEnvironment(BookshareUtils.http+"www.bookshare.org/bookInfo?titleInstanceId="+a),dataType:"json",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(a){d.initViewer(a)},error:function(b){d.handleError(a,b)}};if(BookshareUtils.isIE9())b.dataType=
"jsonp",b.xhrFields=null;$.ajax(b)},initViewer:function(a){console.log("Initializing Book Viewer");window._epub=new Readium.Models.EPUB(a);window._epubController=new Readium.Models.EPUBController(_.extend({epub:window._epub},a));window._applicationView=new Readium.Views.ViewerApplicationView({model:window._epubController});window._applicationView.render()},handleError:function(a,d){var b={},c;switch(d.status){case 401:c="integration_error_401";b.loginUrl=BookshareUtils.resolveEnvironment(BookshareUtils.http+
"www.bookshare.org/");break;case 403:c="integration_error_403";break;case 404:c="integration_error_404";b.titleDetailPageUrl=BookshareUtils.resolveEnvironment(BookshareUtils.http+"www.bookshare.org/browse/book/"+a);break;default:c="integration_error"}BookshareUtils.raiseSystemAlert(c,b)},splat_handler:function(a){console.log(a)}});
Readium.Models.EPUB=Backbone.Model.extend({defaults:{can_two_up:!0},initialize:function(){this.packageDocument=new Readium.Models.PackageDocument({book:this,file_path:this.get("package_doc_path")})},getPackageDocument:function(){return this.packageDocument},toJSON:function(){return{apple_fixed:this.get("apple_fixed"),author:this.get("author"),cover_href:this.get("cover_href"),created_at:this.get("created_at"),description:this.get("description"),epub_version:this.get("epub_version"),fixed_layout:this.get("fixed_layout"),
id:this.get("id"),key:this.get("key"),language:this.get("language"),layout:this.get("layout"),modified_date:this.get("modified_date"),ncx:this.get("ncx"),open_to_spread:this.get("open_to_spread"),orientation:this.get("orientation"),package_doc_path:this.get("package_doc_path"),page_prog_dir:this.get("page_prog_dir"),paginate_backwards:this.get("paginate_backwards"),pubdate:this.get("pubdate"),publisher:this.get("publisher"),rights:this.get("rights"),spread:this.get("spread"),src_url:this.get("src_url"),
title:this.get("title")}},resolvePath:function(a){return this.packageDocument.resolvePath(a)},isFixedLayout:function(){return this.get("fixed_layout")||this.get("apple_fixed")}});
Readium.Models.PageNumberDisplayLogic=Backbone.Model.extend({initialize:function(){},getGotoPageNumsToDisplay:function(a,b,d,e){return b?d?e==="rtl"?this.displayedPageIsLeft(a)?[a-1,a]:this.displayedPageIsRight(a)?[a,a+1]:[a]:this.displayedPageIsLeft(a)?[a,a+1]:this.displayedPageIsRight(a)?[a-1,a]:[a]:a%2===1?[a,a+1]:[a-1,a]:[a]},getPrevPageNumsToDisplay:function(a,b,d){return b?d==="rtl"?this.displayedPageIsLeft(a)&&this.displayedPageIsRight(a-1)?[a-1,a]:[a]:this.displayedPageIsRight(a)&&this.displayedPageIsLeft(a-
1)?[a-1,a]:[a]:[a-1,a]},getNextPageNumsToDisplay:function(a,b,d){return b?d==="rtl"?this.displayedPageIsRight(a)&&this.displayedPageIsLeft(a+1)?[a,a+1]:[a]:this.displayedPageIsLeft(a)&&this.displayedPageIsRight(a+1)?[a,a+1]:[a]:[a,a+1]},getPageNumbersForTwoUp:function(a,b,d,e){var c=[];a?c[0]=b[0]===0?1:b[0]:e?d==="rtl"?this.displayedPageIsLeft(b[0])?(c[0]=b[0]-1,c[1]=b[0]):this.displayedPageIsRight(b[0])&&(c[0]=b[0],c[1]=b[0]+1):this.displayedPageIsLeft(b[0])?(c[0]=b[0],c[1]=b[0]+1):this.displayedPageIsRight(b[0])&&
(c[0]=b[0]-1,c[1]=b[0]):b[0]%2===1?(c[0]=b[0],c[1]=b[0]+1):(c[0]=b[0]-1,c[1]=b[0]);return c},displayedPageIsRight:function(a){return $("#page-"+a).hasClass("right_page")?!0:!1},displayedPageIsLeft:function(a){return $("#page-"+a).hasClass("left_page")?!0:!1},displayedPageIsCenter:function(a){return $("#page-"+a).hasClass("center_page")?!0:!1}});
Readium.Models.ReadiumPagination=Backbone.Model.extend({defaults:{num_pages:0},initialize:function(){this.epubController=this.get("model");this.set("current_page",[this.epubController.get("spine_position")+1]);this.pageNumberDisplayLogic=new Readium.Models.PageNumberDisplayLogic;this.on("change:num_pages",this.adjustCurrentPage,this)},toggleTwoUp:function(){this.epubController.get("can_two_up")&&this.set({current_page:this.pageNumberDisplayLogic.getPageNumbersForTwoUp(this.epubController.get("two_up"),
this.get("current_page"),this.epubController.epub.get("page_prog_dir"),this.epubController.getCurrentSection().isFixedLayout())})},goRight:function(){this.epubController.epub.get("page_prog_dir")==="rtl"?this.prevPage():this.nextPage()},goLeft:function(){this.epubController.epub.get("page_prog_dir")==="rtl"?this.nextPage():this.prevPage()},goToPage:function(a){this.set("current_page",this.pageNumberDisplayLogic.getGotoPageNumsToDisplay(a,this.epubController.get("two_up"),this.epubController.getCurrentSection().isFixedLayout(),
this.epubController.epub.get("page_prog_dir")))},isPageVisible:function(a){return this.get("current_page").indexOf(a)!==-1},prevPage:function(){this.epubController.trigger("pagesPrevPage");var a=this.get("current_page"),b=a[0]-1;a[0]<=1?this.epubController.goToPrevSection():this.epubController.paginator.shouldScroll()&&!this.epubController.getCurrentSection().isFixedLayout()?this.epubController.goToPrevSection():this.epubController.get("two_up")?(this.set("current_page",this.pageNumberDisplayLogic.getPrevPageNumsToDisplay(b,
this.epubController.getCurrentSection().isFixedLayout(),this.epubController.epub.get("page_prog_dir"))),this.epubController.get("rendered_spine_items").length>1&&(a=this.epubController.get("rendered_spine_items")[b>1?b-2:0],this.epubController.set("spine_position",a))):(this.set("current_page",[b]),this.epubController.get("rendered_spine_items").length>1&&(a=this.epubController.get("rendered_spine_items")[b-1],this.epubController.set("spine_position",a)))},nextPage:function(){this.epubController.trigger("pagesNextPage");
var a=this.get("current_page"),b=a[a.length-1]+1;a[a.length-1]>=this.get("num_pages")?this.epubController.goToNextSection():(this.epubController.get("two_up")?this.set("current_page",this.pageNumberDisplayLogic.getNextPageNumsToDisplay(b,this.epubController.getCurrentSection().isFixedLayout(),this.epubController.epub.get("page_prog_dir"))):this.set("current_page",[b]),this.epubController.get("rendered_spine_items").length>1&&(a=this.epubController.get("rendered_spine_items")[b-1],this.epubController.set("spine_position",
a)))},adjustCurrentPage:function(){var a=this.get("current_page"),b=this.get("num_pages");this.epubController.get("two_up");a[a.length-1]>b&&this.goToLastPage()},goToLastPage:function(){this.goToPage(this.get("num_pages"))}});
(function(){var i=Handlebars.template,j=Handlebars.templates=Handlebars.templates||{};j.binding_template=i(function(e,b,c){this.compilerInfo=[4,">= 1.0.0"];this.merge(c,e.helpers);return'<iframe scrolling="no" \n\t\tframeborder="0" \n\t\tmarginwidth="0" \n\t\tmarginheight="0" \n\t\twidth="100%" \n\t\theight="100%" \n\t\tclass=\'binding-sandbox\'>\n</iframe>'});j.extracting_item_template=i(function(e,b,c,d,f){this.compilerInfo=[4,">= 1.0.0"];var c=this.merge(c,e.helpers),f=f||{},e="",a,d=this.escapeExpression;
e+="<h5>";(a=c.log_message)?a=a.call(b,{hash:{},data:f}):(a=b&&b.log_message,a=typeof a==="function"?a.call(b,{hash:{},data:f}):a);e+=d(a)+'</h5>\n<div class="progress progress-striped progress-success active ">\t\n\t\t<div role="status" aria-live="assertive" aria-relevant="all" class="bar" style="width: ';(a=c.progress)?a=a.call(b,{hash:{},data:f}):(a=b&&b.progress,a=typeof a==="function"?a.call(b,{hash:{},data:f}):a);e+=d(a)+'%;"></div>\n</div>';return e});j.fixed_page_template=i(function(e,b,c,
d,f){this.compilerInfo=[4,">= 1.0.0"];var c=this.merge(c,e.helpers),f=f||{},e="",a,d=this.escapeExpression;e+='<div class="fixed-page-margin">\n\t<iframe scrolling="no" \n\t\t\tframeborder="0" \n\t\t\tmarginwidth="0" \n\t\t\tmarginheight="0" \n\t\t\twidth="';(a=c.width)?a=a.call(b,{hash:{},data:f}):(a=b&&b.width,a=typeof a==="function"?a.call(b,{hash:{},data:f}):a);e+=d(a)+'px" \n\t\t\theight="';(a=c.height)?a=a.call(b,{hash:{},data:f}):(a=b&&b.height,a=typeof a==="function"?a.call(b,{hash:{},data:f}):
a);e+=d(a)+'px" \n\t\t\tsrc="';(a=c.uri)?a=a.call(b,{hash:{},data:f}):(a=b&&b.uri,a=typeof a==="function"?a.call(b,{hash:{},data:f}):a);e+=d(a)+'"\n\t\t\ttitle="'+d((a=(a=b&&b.data,a==null||a===!1?a:a.title),typeof a==="function"?a.apply(b):a))+"\"\n\t\t\tclass='content-sandbox'>\n\t</iframe>\n</div>";return e});j.iframe_keyboard_shortcuts=i(function(e,b,c,d,f){this.compilerInfo=[4,">= 1.0.0"];c=this.merge(c,e.helpers);f=f||{};e="";e+='<div id="hiddenAccessKeys" style="display:none">\n\t<span>Available actions</span>\n\t<a accesskey="b" href="#">Back to Bookshare.org</a>\n\t<a accesskey="1" href="#">Next</a>\n\t<a accesskey="2" href="#">Previous</a>\n\t<a accesskey="t" href="#">Table of contents</a>\n\t';
if((b=c["if"].call(b,b&&b.ttsEnabled,{hash:{},inverse:this.noop,fn:this.program(1,function(){return'\n\t<a accesskey="p" href="#">Text to speech</a>\n\t'},f),data:f}))||b===0)e+=b;e+='\t\n\t<a accesskey="o" href="#">Options</a>\n\t<a accesskey="n" href="#">Toggle night mode</a>\n\t<a accesskey="f" href="#">Toggle fullscreen mode</a>\n\t<a accesskey="h" href="#">Help</a>\n\t<a accesskey="x" href="#">Hide toolbar</a>\n\t<a accesskey="v" href="#">Show toolbar</a>\n</div>';return e});j.image_page_template=
i(function(e,b,c,d,f){this.compilerInfo=[4,">= 1.0.0"];c=this.merge(c,e.helpers);f=f||{};e="";d=this.escapeExpression;e+='<div class="fixed-page-margin">\n\t<img src="';(c=c.uri)?b=c.call(b,{hash:{},data:f}):(c=b&&b.uri,b=typeof c==="function"?c.call(b,{hash:{},data:f}):c);e+=d(b)+'" alt="" />\n</div>';return e});j.injected_reflowing_template=i(function(e,b,c){this.compilerInfo=[4,">= 1.0.0"];this.merge(c,e.helpers);var e="",d,c=this.escapeExpression;e+='<div id="flowing-wrapper">\n\t<iframe scrolling="no" \n\t\t\tframeborder="0" \n\t\t\tmarginwidth="0" \n\t\t\tmarginheight="0" \n\t\t\twidth="50%" \n\t\t\theight="100%" \n\t\t\ttitle="'+
c((d=(d=b&&b.data,d==null||d===!1?d:d.title),typeof d==="function"?d.apply(b):d))+" by "+c((d=(d=b&&b.data,d==null||d===!1?d:d.author),typeof d==="function"?d.apply(b):d))+'"\n\t\t\tsrc="/page.xhtml"\n\t\t\tid="readium-flowing-content"\n\t\t\taria-live="polite"\n\t\t\t>\n\t</iframe>\n</div>';return e});j.injected_scrolling_page_template=i(function(e,b,c){this.compilerInfo=[4,">= 1.0.0"];this.merge(c,e.helpers);var e="",d,c=this.escapeExpression;e+='<div id="scrolling-wrapper">\n\t<iframe scrolling="yes" \n\t\t\tframeborder="0" \n\t\t\tmarginwidth="0" \n\t\t\tmarginheight="0" \n\t\t\twidth="100%" \n\t\t\theight="100%" \n\t\t\ttitle="'+
c((d=(d=b&&b.data,d==null||d===!1?d:d.title),typeof d==="function"?d.apply(b):d))+" by "+c((d=(d=b&&b.data,d==null||d===!1?d:d.author),typeof d==="function"?d.apply(b):d))+'"\n\t\t\tsrc="/page.xhtml"\n\t\t\tid=\'readium-scrolling-content\'\n\t\t\taria-live="polite"\n\t\t\t>\n\t</iframe>\n</div>';return e});j.integration_error=i(function(e,b,c){this.compilerInfo=[4,">= 1.0.0"];this.merge(c,e.helpers);return'<h3>An error has occurred</h3>\n<p>\nAn unexpected error has occurred while trying to obtain book information.\nPlease wait a few moments and try reloading this page. If the problem\npersists, please\n<a href="https://www.bookshare.org/contactUs">contact Bookshare Support</a>.\n</p>\n'});
j.integration_error_401=i(function(e,b,c,d,f){this.compilerInfo=[4,">= 1.0.0"];c=this.merge(c,e.helpers);f=f||{};e="";d=this.escapeExpression;e+='<h3>Please log in</h3>\n<p>\n\tYou do not appear to be logged in to Bookshare.\n\tPlease <a href="';(c=c.loginUrl)?b=c.call(b,{hash:{},data:f}):(c=b&&b.loginUrl,b=typeof c==="function"?c.call(b,{hash:{},data:f}):c);e+=d(b)+'">click here</a>\n\tto return to Bookshare and log in to your account.\n</p>';return e});j.integration_error_403=i(function(e,b,c){this.compilerInfo=
[4,">= 1.0.0"];this.merge(c,e.helpers);return'<h3>You do not have permission to view this title</h3>\n<p>\nYou do not have permission to access the requested title. If\nyou feel this message is in error please\n<a href="https://www.bookshare.org/contactUs">contact Bookshare Support</a>.\n</p>\n'});j.integration_error_404=i(function(e,b,c,d,f){this.compilerInfo=[4,">= 1.0.0"];c=this.merge(c,e.helpers);f=f||{};e="";d=this.escapeExpression;e+='<h3>Title is not ready for web reading</h3>\n<p>\nThe title you have requested has not been prepared\nfor reading on the web. Please go to the \n<a href="';
(c=c.titleDetailPageUrl)?b=c.call(b,{hash:{},data:f}):(c=b&&b.titleDetailPageUrl,b=typeof c==="function"?c.call(b,{hash:{},data:f}):c);e+=d(b)+'">title detail page</a>\nand click on the "Read Now" link.\n</p>';return e});j.library_item_template=i(function(e,b,c,d,f){this.compilerInfo=[4,">= 1.0.0"];var c=this.merge(c,e.helpers),f=f||{},e="",a,g,h,d=this.escapeExpression,i=c.helperMissing;e+="<div class='info-wrap clearfix'>\n\t<div class='caption book-info'>\n\t\t<h2 class='green info-item title'>"+
d((a=(a=b&&b.data,a==null||a===!1?a:a.title),typeof a==="function"?a.apply(b):a))+"</h2>\n\t\t<div class='info-item author'>"+d((g=c.orUnknown||b&&b.orUnknown,h={hash:{},data:f},g?g.call(b,(a=b&&b.data,a==null||a===!1?a:a.author),h):i.call(b,"orUnknown",(a=b&&b.data,a==null||a===!1?a:a.author),h)))+"</div>\n\t\t<div class='info-item epub-version'>ePUB "+d((g=c.orUnknown||b&&b.orUnknown,h={hash:{},data:f},g?g.call(b,(a=b&&b.data,a==null||a===!1?a:a.epub_version),h):i.call(b,"orUnknown",(a=b&&b.data,
a==null||a===!1?a:a.epub_version),h)))+"</div>\t\t\n\t</div>\n\t\n\t<img class='cover-image read' src='"+d((a=(a=b&&b.data,a==null||a===!1?a:a.cover_href),typeof a==="function"?a.apply(b):a))+"' width='150' height='220' alt='Open ePUB "+d((a=(a=b&&b.data,a==null||a===!1?a:a.title),typeof a==="function"?a.apply(b):a))+"'>\n\t\n\t<a href=\"#details-modal-"+d((a=(a=b&&b.data,a==null||a===!1?a:a.key),typeof a==="function"?a.apply(b):a))+'" class="info-icon" aria-pressed="true" data-toggle="modal" role="button">\n\t\t<img class=\'info-icon pull-right\' src=\'/images/library/info-icon.png\' height="39px" width="39px" alt=\''+
d((a=(a=b&&b.data,a==null||a===!1?a:a.title),typeof a==="function"?a.apply(b):a))+' information\'>\n\t</a>\n</div>\n\n<div class="caption clearfix buttons">\n\t<a href="#todo" class="btn read" data-book=\''+d((a=(a=b&&b.data,a==null||a===!1?a:a.key),typeof a==="function"?a.apply(b):a))+"' role='button'>Read</a>\n\t<a href=\"#details-modal-"+d((a=(a=b&&b.data,a==null||a===!1?a:a.key),typeof a==="function"?a.apply(b):a))+'" aria-pressed="true" class="btn details" data-toggle="modal" role="button">\n\t\tDetails\n\t</a>\n</div>\n\n<div id=\'details-modal-'+
d((a=(a=b&&b.data,a==null||a===!1?a:a.key),typeof a==="function"?a.apply(b):a))+"' class='modal fade details-modal'>\n<div class=\"offscreenText\"> Details Start </div>\n\t<div class=\"pull-left modal-cover-wrap\">\n\t\t<img class='details-cover-image' src='"+d((a=(a=b&&b.data,a==null||a===!1?a:a.cover_href),typeof a==="function"?a.apply(b):a))+"' width='150' height='220' alt='ePUB cover'>\n\t\t<div class=\"caption clearfix modal-buttons\">\n\t\t\t<a href=\"#\" class=\"btn read\" data-book='<%= data.key %>' role='button'>Read</a>\n\t\t\t<a class=\"btn btn-danger delete pull-right\" role='button'>Delete</a>\n\t\t</div>\n\t</div>\n\t<div class='caption modal-book-info'>\n\t\t<div class='green modal-title'>"+
d((a=(a=b&&b.data,a==null||a===!1?a:a.title),typeof a==="function"?a.apply(b):a))+"</div>\n\t\t<div class='modal-detail gap'>Author: "+d((g=c.orUnknown||b&&b.orUnknown,h={hash:{},data:f},g?g.call(b,(a=b&&b.data,a==null||a===!1?a:a.author),h):i.call(b,"orUnknown",(a=b&&b.data,a==null||a===!1?a:a.author),h)))+"</div>\n\t\t<div class='modal-detail'>Publisher: "+d((g=c.orUnknown||b&&b.orUnknown,h={hash:{},data:f},g?g.call(b,(a=b&&b.data,a==null||a===!1?a:a.publisher),h):i.call(b,"orUnknown",(a=b&&b.data,
a==null||a===!1?a:a.publisher),h)))+"</div>\n\t\t<div class='modal-detail'>Pub Date: "+d((g=c.orUnknown||b&&b.orUnknown,h={hash:{},data:f},g?g.call(b,(a=b&&b.data,a==null||a===!1?a:a.pubdate),h):i.call(b,"orUnknown",(a=b&&b.data,a==null||a===!1?a:a.pubdate),h)))+"</div>\n\t\t<div class='modal-detail'>Modified Date: "+d((g=c.orUnknown||b&&b.orUnknown,h={hash:{},data:f},g?g.call(b,(a=b&&b.data,a==null||a===!1?a:a.modified_date),h):i.call(b,"orUnknown",(a=b&&b.data,a==null||a===!1?a:a.modified_date),
h)))+"</div>\n\t\t<div class='modal-detail gap'>ID: "+d((g=c.orUnknown||b&&b.orUnknown,h={hash:{},data:f},g?g.call(b,(a=b&&b.data,a==null||a===!1?a:a.id),h):i.call(b,"orUnknown",(a=b&&b.data,a==null||a===!1?a:a.id),h)))+"</div>\n\t\t<div class='modal-detail green'>Format: ePUB "+d((g=c.orUnknown||b&&b.orUnknown,h={hash:{},data:f},g?g.call(b,(a=b&&b.data,a==null||a===!1?a:a.epub_version),h):i.call(b,"orUnknown",(a=b&&b.data,a==null||a===!1?a:a.epub_version),h)))+"</div>\n\t\t<div class='modal-detail'>Added: "+
d((g=c.orUnknown||b&&b.orUnknown,h={hash:{},data:f},g?g.call(b,(a=b&&b.data,a==null||a===!1?a:a.created_at),h):i.call(b,"orUnknown",(a=b&&b.data,a==null||a===!1?a:a.created_at),h)))+"</div>\n\t</div>\n\t<div class='modal-detail source'>\n\t<span class='green' style=\"padding-right: 10px\">Source:</span>\n\t\t"+d((g=c.orUnknown||b&&b.orUnknown,h={hash:{},data:f},g?g.call(b,(a=b&&b.data,a==null||a===!1?a:a.src_url),h):i.call(b,"orUnknown",(a=b&&b.data,a==null||a===!1?a:a.src_url),h)))+'\n\t</div>\n<div class="offscreenText"> Details End </div>\n</div>\t\t\t';
return e});j.library_items_template=i(function(e,b,c){this.compilerInfo=[4,">= 1.0.0"];this.merge(c,e.helpers);return"<div id='empty-message'>\n\t<p id='empty-message-text' class='green'>\n\t\tAdd items to your</br>library here!\n\t</p>\n\t<img id='empty-arrow' src='/images/library/empty_library_arrow.png' alt='Try adding an ePUB' />\n</div>"});j.loading_content=i(function(e,b,c){this.compilerInfo=[4,">= 1.0.0"];this.merge(c,e.helpers);return'<h3>Loading book content...</h3>\n<p style="text-align:center">\n<img src="/images/progress_bar.gif" alt="Loading content...">\n</p>\n'});
j.ncx_nav_template=i(function(e,b,c,d,f){this.compilerInfo=[4,">= 1.0.0"];var c=this.merge(c,e.helpers),f=f||{},e="",a,d=this.escapeExpression;e+='<li class="nav-elem">\n\t<a href="';(a=c.href)?a=a.call(b,{hash:{},data:f}):(a=b&&b.href,a=typeof a==="function"?a.call(b,{hash:{},data:f}):a);e+=d(a)+'">';(a=c.text)?a=a.call(b,{hash:{},data:f}):(a=b&&b.text,a=typeof a==="function"?a.call(b,{hash:{},data:f}):a);e+=d(a)+"</a>\n</li>";return e});j.reflowing_template=i(function(e,b,c,d,f){this.compilerInfo=
[4,">= 1.0.0"];var c=this.merge(c,e.helpers),f=f||{},e="",a,d=this.escapeExpression;e+='<div id="flowing-wrapper">\n\t<iframe scrolling="no" \n\t\t\tframeborder="0" \n\t\t\tmarginwidth="0" \n\t\t\tmarginheight="0" \n\t\t\twidth="50%" \n\t\t\theight="100%" \n\t\t\ttitle="'+d((a=(a=b&&b.data,a==null||a===!1?a:a.title),typeof a==="function"?a.apply(b):a))+'"\n\t\t\tsrc="';(c=c.uri)?a=c.call(b,{hash:{},data:f}):(c=b&&b.uri,a=typeof c==="function"?c.call(b,{hash:{},data:f}):c);e+=d(a)+'"\n\t\t\tid="readium-flowing-content">\n\t</iframe>\n</div>';
return e});j.scrolling_page_template=i(function(e,b,c,d,f){this.compilerInfo=[4,">= 1.0.0"];var c=this.merge(c,e.helpers),f=f||{},e="",a,d=this.escapeExpression;e+='<div id="scrolling-content" class="scrolling-page-wrap">\n\t<div class="scrolling-page-margin">\n\n\t\t<iframe scrolling="yes" \n\t\t\t\tframeborder="0" \n\t\t\t\tmarginwidth="0" \n\t\t\t\tmarginheight="0" \n\t\t\t\twidth="100%" \n\t\t\t\theight="100%" \n\t\t\t\ttitle="'+d((a=(a=b&&b.data,a==null||a===!1?a:a.title),typeof a==="function"?
a.apply(b):a))+'"\n\t\t\t\tsrc="';(c=c.uri)?a=c.call(b,{hash:{},data:f}):(c=b&&b.uri,a=typeof c==="function"?c.call(b,{hash:{},data:f}):c);e+=d(a)+"\"\n\t\t\t\tclass='content-sandbox'>\n\t\t</iframe>\n\t</div>\n</div>";return e})})();
(function(f){f.Acc={detailed:[],title:"",page:"",RadioGroup:function(i,f,g){var h=$("#"+i).get(0),b={},a=this,c=function(d,b){$("#"+h.id+" > *").attr({tabindex:"-1","aria-selected":"false","aria-checked":"false"});$(a.childNodes[d]).attr({tabindex:"0","aria-selected":"true","aria-checked":"true"});b&&$(a.childNodes[d]).focus();a.selected=a.childNodes[d];a.index=d;g&&typeof g==="function"&&g(a.childNodes[d],a.childNodes)};a.childNodes=$("#"+h.id+" > *").each(function(a,c){b[c.id]=a;b.max=a+1;$(c).attr({tabindex:"-1",
"aria-selected":"false","aria-checked":"false","aria-posinset":b.max})}).get();$("#"+h.id+" > *").attr("aria-setsize",b.max).bind({click:function(){this!=a.selected&&c(b[this.id])},keydown:function(d){var e=d.which||d.keyCode;if(e==37||e==38)a.index>0?c(a.index-1,!0):c(b.max-1,!0);else if(e==39||e==40)a.index<b.max-1?c(a.index+1,!0):c(0,!0),d.stopPropagation()}});a.set=function(a){c(b[a])};c(b[$("#"+i+f).get(0).id])}}})(window);
var BeneSpeak={wordHighlightClass:"ttsWordHL",sentenceHighlightClass:"ttsSentHL",BOUNDARY_CHARS:/[\.,](?=\s|$)|[\!\?\s\"\;\u201c\u201d\u2013\u2014]/g,SENTENCE_TERMINATORS:/[\.\?\!]/,WORD_SEPARATORS:/[\s",;\u201c\u201d\u2013\u2014]/,CONDITIONAL_SEPARATORS:/'\u2018\u2019/,IGNORE_ELEMENTS:/beelinespan/,SpeechData:function(){this.document=null;this.utterance="";this.words=[];this.sentences=[];this._highlightedSentence=this._highlightedWord=-1;this._sipStart=null;this._sipOffset=-1;this._wipStart=null;
this._wordRects=[];this._sentenceRects=[];this.yOffset=this.xOffset=0},Fragment:function(a,c){this.range=a;this.offset=c;this.text=this.range.toString()},Position:function(a,c){this.node=a;this.offset=c},generateSpeechData:function(a){r=new BeneSpeak.SpeechData;BeneSpeak._tokenize(a,r);return r},_tokenize:function(a,c){if(c.document==null)c.document=a.ownerDocument;switch(a.nodeType){case Node.ELEMENT_NODE:for(var b=a.childNodes,d=0;d<b.length;d++)this._tokenize(b[d],c);BeneSpeak._processElementBoundary(c,
a);break;case Node.TEXT_NODE:b=a.textContent;if(c._wipStart==null&&(d=/\S/.exec(b),d!=null))c._wipStart=new BeneSpeak.Position(a,d.index);if(c._wipStart!=null)for(d=this.BOUNDARY_CHARS.exec(b);d!=null;){if(c._sipStart==null)c._sipStart=c._wipStart.copy(),c._sipOffset=c.utterance.length;BeneSpeak._processWordBoundary(c,a,d);this.SENTENCE_TERMINATORS.test(d[0])==!0&&(c.utterance+=" ",BeneSpeak._processSentenceBoundary(c,a,d));d=this.BOUNDARY_CHARS.exec(b)}}return c},speak:function(a,c){var b=this.generateSpeechData(a);
chrome.tts.speak(b.utterance,{rate:1.25,onEvent:function(a){b.handleTtsEvent(a,c)}})},stop:function(){chrome.tts.stop()},_isBlockElement:function(a){a=window.getComputedStyle(a);return a.display.indexOf("inline")==-1&&a.display.indexOf("ruby")==-1},_processWordBoundary:function(a,c,b){var d=a.document.createRange();d.setStart(a._wipStart.node,a._wipStart.offset);d.setEnd(c,b.index);d=new BeneSpeak.Fragment(d,a.utterance.length);d.text.length>0&&a.words.push(d);a.utterance+=d.text;a.utterance+=b[0];
a._wipStart=b.index+1<c.textContent.length?new BeneSpeak.Position(c,b.index+1):null},_processSentenceBoundary:function(a,c,b){var d=a.document.createRange();d.setStart(a._sipStart.node,a._sipStart.offset);d.setEnd(c,b.index+1);for(c=0;c<a.words.length;c++)if(b=a.words[c].range.startOffset,b.startContainer==a._sipStart.node&&b.startOffset==a._sipStart.offset)break;d=new BeneSpeak.Fragment(d,a._sipOffset);d.text.length>0&&a.sentences.push(d);a._sipStart=null;a._sipOffset=0},_processElementBoundary:function(a,
c){var b=this.IGNORE_ELEMENTS.test(c.nodeName);if(a._wipStart!=null&&!b){var d=a.document.createRange();d.setStart(a._wipStart.node,a._wipStart.offset);d.setEndAfter(c);d=new BeneSpeak.Fragment(d,a.utterance.length);d.text.length>0&&a.words.push(d);a.utterance+=d.text;a._wipStart=null}if(a._sipStart!=null&&this._isBlockElement(c))d=a.document.createRange(),d.setStart(a._sipStart.node,a._sipStart.offset),d.setEndAfter(c),d=new BeneSpeak.Fragment(d,a._sipOffset),d.text.length>0&&a.sentences.push(d),
a._sipStart=null,a._sipOffset=0;b||(a.utterance+="\n")},_elementStartAnnouncement:function(a,c){var b=c.tagName.toLowerCase();b=="table"?a.utterance+="\nBegin table. ":b=="tr"?a.utterance+="\nBegin table row. ":b=="td"?a.utterance+="\nTable cell. ":b=="ol"?a.utterance+="\nBegin ordered list. ":b=="ul"?a.utterance+="\nBegin list. ":b=="li"&&(a.utterance+="\nList item. ")},_elementEndAnnouncement:function(a,c){var b=c.tagName.toLowerCase();b=="table"?a.utterance+="\nEnd table. ":b=="tr"?a.utterance+=
"\nEnd table row. ":b=="ol"?a.utterance+="\nEnd ordered list. ":b=="ul"&&(a.utterance+="\nEnd list. ")}};BeneSpeak.SpeechData.prototype.clearWordHighlight=function(){for(;this._wordRects.length>0;)this.document.body.removeChild(this._wordRects.pop());this._highlightedWord=-1};BeneSpeak.SpeechData.prototype.clearSentenceHighlight=function(){for(;this._sentenceRects.length>0;)this.document.body.removeChild(this._sentenceRects.pop());this._highlightedSentence=-1};
BeneSpeak.SpeechData.prototype.handleTtsEvent=function(a,c){if(a.type=="word"){var b=this.wordAt(a.charIndex);b>=0&&this.highlightWord(b);b=this.sentenceAt(a.charIndex);b>=0&&this.highlightSentence(b)}else if(a.type=="interrupted"||a.type=="end")this.clearWordHighlight(),this.clearSentenceHighlight(),c!=null&&c()};
BeneSpeak.SpeechData.prototype.highlightWord=function(a){if(this._highlightedWord!=a){this.clearWordHighlight();this._highlightedWord=a;for(var a=this.words[a].range.getClientRects(),c=0;c<a.length;c++){var b=this.document.createElement("div");this.document.body.appendChild(b);b.className=BeneSpeak.wordHighlightClass;b.style.position="absolute";b.style.top=a[c].top+window.scrollY+this.yOffset+"px";b.style.left=a[c].left+window.scrollX+this.xOffset+"px";b.style.width=a[c].width+"px";b.style.height=
a[c].height+"px";this._wordRects.push(b)}}};
BeneSpeak.SpeechData.prototype.highlightSentence=function(a){if(this._highlightedSentence!=a){this.clearSentenceHighlight();this._highlightedSentence=a;for(var a=this.sentences[a].range.getClientRects(),c=0;c<a.length;c++){var b=this.document.createElement("div");this.document.body.appendChild(b);b.className=BeneSpeak.sentenceHighlightClass;b.style.position="absolute";b.style.top=a[c].top+window.scrollY+this.yOffset+"px";b.style.left=a[c].left+window.scrollX+this.xOffset+"px";b.style.width=a[c].width+
"px";b.style.height=a[c].height+"px";this._sentenceRects.push(b)}}};BeneSpeak.SpeechData.prototype._getOffset=function(a){return a.slice(-2)=="px"?0-parseInt(a.substring(0,a.length-2)):0};BeneSpeak.SpeechData.prototype.wordAt=function(a,c){for(var b=c?0:this._highlightedWord==-1?0:this._highlightedWord;b<this.words.length;b++){if(a<this.words[b].offset)return b-1;if(this.words[b].includes(a))return b}return-1};
BeneSpeak.SpeechData.prototype.sentenceAt=function(a,c){for(var b=c?0:this._highlightedSentence==-1?0:this._highlightedSentence;b<this.sentences.length;b++)if(a<this.sentences[b].offset)return b-1;else if(this.sentences[b].includes(a))return b;return-1};BeneSpeak.Fragment.prototype.includes=function(a){return a>=this.offset&&a<this.offset+this.text.length};BeneSpeak.Position.prototype.copy=function(){return new BeneSpeak.Position(this.node,this.offset)};
window.BookshareUtils={environment:"LIVE",ie9Flag:null,POSITION_TRACKING_EXCLUSIONS:["html","section","div"],AWS_URL_PATTERN:/https\:\/\/(?:(qa|staging)\-){0,1}bookshare\-reader\.s3\.amazonaws\.com\/(?:\w+\/)?viewer\.html\?book=(\d*)/,isIOS:function(){if(this.iosFlag==null)this.iosFlag=["iPhone","iPad","iPod"].indexOf(navigator.platform)>-1;return this.iosFlag},isAndroidOrWindowsPhone:function(){return/android/i.test(navigator.userAgent||navigator.vendor||window.opera)},isChromeOS:function(){return navigator.appVersion.indexOf("CrOS")!=
-1},isFirefox:function(){return typeof InstallTrigger!=="undefined"},isIE:function(){return!!document.documentMode},isEdge:function(){return!this.isIE()&&!!window.StyleMedia},hasSpeechAPI:function(){return(window.speechSynthesis&&window.speechSynthesis.getVoices&&window.SpeechSynthesisUtterance)!=void 0&&!this.isIOS()},offerChromeExtension:function(){return window.chrome&&!this.hasSpeechAPI()&&!window.chrome.extension&&navigator.userAgent.indexOf("Android")==-1&&BookshareUtils.environment=="LIVE"&&
navigator.userAgent.search(/silk/i)==-1},flatten:function(a){return this.environment=="DEV"?a.substr(a.lastIndexOf("/")):a},makeSyncFunction:function(a,b,d){return function(e,c,f){c=a(c);if(!c)throw"Cannot sync the model without a valid sync URL.";switch(e){case "read":e={url:c,dataType:b,xhrFields:{withCredentials:!0},crossDomain:!0,success:function(a){f.success(a)},error:function(a){f.error(a)}};if(d)e.dataType="jsonp "+b,e.xhrFields=null;$.ajax(e);break;case "create":throw"Not yet implemented";
case "update":throw"Not yet implemented";case "delete":throw"Not yet implemented";}return null}},resolveUrl:function(a){var b;b=a.substring(0,3)=="../"?a.substring(3):a;b=BookshareUtils.flatten(b);a=window._epub.packageDocument.get("manifest").find(function(a){return(new URI(a.get("href"))).path.indexOf(b)>-1});return a==null?null:a.get("href")},setEnvironment:function(a){BookshareUtils.http="https://";var b=/\/(\w+)\/viewer.html/.exec(location.pathname);BookshareUtils.domain=(b?b[1]:"bookshare")+
".org";if(/\bdev\b/.test(location.hostname))BookshareUtils.environment="DEV",BookshareUtils.http="http://";else if(a=window.chrome&&window.chrome.extension?/chrome\-extension\:\/\/\w*?\/views\/viewer\.html\?book=\d*?(?:&env=(\w*))/.exec(a):BookshareUtils.AWS_URL_PATTERN.exec(a),a!=null)if(a[1]=="qa")BookshareUtils.environment="QA";else if(a[1]=="staging")BookshareUtils.environment="STAGING"},resolveEnvironment:function(a){a=new URI(a);if(a.authority=="www.bookshare.org")a.authority=BookshareUtils.environment==
"QA"?"public.qa."+BookshareUtils.domain:BookshareUtils.environment=="STAGING"?"public.staging."+BookshareUtils.domain:BookshareUtils.environment=="DEV"?"public.dev."+BookshareUtils.domain+":8080":"www."+BookshareUtils.domain;return a.toString()},raiseSystemAlert:function(a,b){var d=Handlebars.templates[a];$("#system-message-content").html(d(b!=null?b:{}));$("#system-message").modal({backdrop:"static",keyboard:!1})},dismissSystemAlert:function(){$("#system-message").modal("hide");$("#system-message-content").html("")},
beelineNotification:function(a){a.get("show_beeline_alert")&&((new BeeLineReader($("#beeline-notification-modal .modal-body p").get(0),{theme:"bright",skipBackgroundColor:!1,colorImmediately:!0,handleResize:!0})).color(),$("#beeline-notification-button-yes").click(function(){a.set("show_beeline_alert",!1);a.applyOptions();$("#beeline-notification-modal").modal("hide");$("#viewer-settings-modal").modal("show").attr("aria-hidden","true");$("#theme-radio-group span").each(function(){$(this).attr({"aria-selected":"false",
"aria-checked":"false"}).removeClass("selected")});$("#beeline-theme-option").trigger("click");$("#beeline-beta-menu #bright-button").trigger("click")}),$("#beeline-notification-button-no").click(function(){a.set("show_beeline_alert",!1);a.applyOptions();$("#beeline-notification-modal").modal("hide").attr("aria-hidden","true")}),$("#beeline-notification-modal").modal("show").attr("aria-hidden","false"))},findTopElement:function(a){for(var b=a.getFrame(),a=a.model.epub.get("page_prog_dir")=="rtl"?
2*parseInt(b.width.replace("px",""),10)/3:parseInt(b.width.replace("px",""),10)/3,d=null,e=parseInt(b.height.replace("px",""),10),b=b.contentDocument,c=0,d=b.elementFromPoint(a,c);c<e&&d!=null&&this.POSITION_TRACKING_EXCLUSIONS.indexOf(d.tagName.toLowerCase())>-1;)c+=10,d=b.elementFromPoint(a,c);return d},getSelectorForNearestElementWithId:function(a){var b=null;a.getAttribute("id")!=null?b=a.tagName+"#"+a.getAttribute("id"):a.previousElementSibling!=null?b=this.getSelectorForNearestElementWithId(a.previousElementSibling):
a.parentElement!=null&&this.POSITION_TRACKING_EXCLUSIONS.indexOf(a.parentElement.tagName.toLowerCase())==-1&&(b=this.getSelectorForNearestElementWithId(a.parentElement));return b},getSplitUrl:function(a){return a.match(/([^#]*)(?:#(.*))?/)},isIE9:function(){if(this.ie9Flag==null){for(var a=3,b=document.createElement("div"),d=b.getElementsByTagName("i");b.innerHTML="<\!--[if gt IE "+ ++a+"]><i></i><![endif]--\>",d[0];);this.ie9Flag=a===9?!0:!1}return this.ie9Flag},setFocus:function(a){var b=$(window._epubController.paginator.v.getFrame());
b.focus();var d=b.contents().find("#"+a);$(d).length>0&&setTimeout(function(){d.attr("tabindex","-1").focus()},500)},getRelativePath:function(a){var b=window._epubController.get("publication_root");if(a.indexOf(b)!==-1)return a.replace(b,"")}};
Readium.Models.PackageDocument.prototype.sync=BookshareUtils.makeSyncFunction(function(a){var b=a.get("book"),a=BookshareUtils.http+"www.bookshare.org/getManifest?titleInstanceId="+b.get("key"),b=b.get("tagId");a+=b?"&tag="+b:"";return BookshareUtils.resolveEnvironment(a)},"xml",BookshareUtils.isIE9());Readium.Models.Toc.prototype.sync=BookshareUtils.makeSyncFunction(function(a){return a.file_path},"xml");
Readium.Models.SpineItem.prototype.sync=window.BookshareUtils.makeSyncFunction(function(a){return a.get("href")},"xml");
Readium.Models.SpineItem.prototype.parse=function(a){var b=this,a=$(a);a.find("head [href]").each(function(){this.setAttribute("href",BookshareUtils.resolveUrl(this.getAttribute("href")))});a.find("[src]").each(function(){this.setAttribute("src",BookshareUtils.resolveUrl(this.getAttribute("src")))});a.find("aside[epub\\:type=annotation]").each(function(a,b){b.style.display="none"});a.find("a[href]").each(function(a,e){e.getAttribute("href").indexOf("#")=="0"&&this.setAttribute("href",BookshareUtils.getRelativePath(b.get("href"))+
e.getAttribute("href"))});a.find("[epub\\:type=pagebreak]").each(function(a,b){$(b).addClass("bksPageNumber");b.textContent==""&&b.getAttribute("title")!=""?b.textContent=b.getAttribute("title"):b.textContent!=""&&b.getAttribute("title")==""&&b.setAttribute("title",b.textContent)});this.content=a[0].documentElement};Readium.Models.PackageDocument.prototype.resolvePath=function(a){return a};
Readium.Models.PackageDocument.prototype.initialize=function(){this.uri_obj=new URI(this.get("book").get("publication_root"));this.on("change:spine_position",this.onSpinePosChanged)};
Readium.Models.PackageDocument.prototype.spineIndexFromHref=function(a){for(var b=this.get("res_spine"),a=new URI(this.resolveUri(a)),d=a.path.substring(a.path.lastIndexOf("/")+1),e=0;e<b.length;e++){var c=b.at(e).get("href"),c=new URI(this.resolveUri(c)),f=c.path.lastIndexOf("%2F")===-1?"/":"%2F",f=c.path.substring(c.path.lastIndexOf(f)+f.length);if(a.scheme===c.scheme&&a.authority===c.authority&&f==d)return e}return-1};
window.XDomainRequest&&BookshareUtils.isIE9()&&jQuery.ajaxTransport(function(a){if(a.crossDomain&&a.async){if(a.timeout)a.xdrTimeout=a.timeout,delete a.timeout;var b;return{send:function(d,e){function c(a,c,d,g){b.onload=b.onerror=b.ontimeout=jQuery.noop;b=void 0;e(a,c,d,g)}b=new XDomainRequest;b.onload=function(){c(200,"OK",{text:b.responseText},"Content-Type: "+b.contentType)};b.onerror=function(){c(404,"Not Found")};b.onprogress=function(){console.log("Fetch in progress")};b.ontimeout=function(){c(0,
"timeout")};b.timeout=1E4;b.open(a.type,a.url);b.send(a.hasContent&&a.data||null)},abort:function(){if(b)b.onerror=jQuery.noop,b.abort()}}}});if(window.BeneSpeak!=null)BeneSpeak._isBlockElement=function(a){a=window.frames[0].getComputedStyle(a);return a.display.indexOf("inline")==-1&&a.display.indexOf("ruby")==-1};
