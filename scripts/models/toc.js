Readium.Models.Toc=Backbone.Model.extend({sync:BBFileSystemSync,initialize:function(a){this.file_path=a.file_path;this.book=a.book;this.book.on("change:toc_visible",this.setVisibility,this);this.book.on("change:toolbar_visible",this.setTocVis,this);this.book.on("change:reading_position",this.updateTocHighlight,this)},handleLink:function(a){this.book.goToHref(a)},setVisibility:function(){this.set("visible",this.book.get("toc_visible"))},hide:function(){this.book.set("toc_visible",!1)},setTocVis:function(){!this.book.get("toolbar_visible")&&
this.book.get("toc_visible")&&this.book.set("toc_visible",!1)},findNearestTocItemSelector:function(){return null},updateTocHighlight:function(){if(this.book.get("toc_visible")){var a=this.book.get("reading_position"),b=this.book.paginator.v.getBody(),a=$(b).find(a);a.length>0&&this.set("toc_highlight_selector",this.findNearestTocItemSelector(a[0]))}},defaults:{visible:!1}},{XHTML_MIME:"application/xhtml+xml",XML_MIME:"text/xml",NCX_MIME:"application/x-dtbncx+xml",getToc:function(a,b){var c=a.get("media_type");
if(c===Readium.Models.Toc.XHTML_MIME||c===Readium.Models.Toc.XML_MIME)return new Readium.Models.XhtmlToc(b);else if(c===Readium.Models.Toc.NCX_MIME)return new Readium.Models.NcxToc(b)}});
Readium.Models.NcxToc=Readium.Models.Toc.extend({jath_template:{title:"//ncx:docTitle/ncx:text",navs:["//ncx:navMap/ncx:navPoint",{text:"ncx:navLabel/ncx:text",href:"ncx:content/@src"}]},parse:function(a){typeof a==="string"&&(a=(new window.DOMParser).parseFromString(a,"text/xml"));Jath.resolver=function(a){return a==="ncx"?"http://www.daisy.org/z3986/2005/ncx/":""};return Jath.parse(this.jath_template,a)},TocView:function(){return new Readium.Views.NcxTocView({model:this})}});
Readium.Models.XhtmlToc=Readium.Models.Toc.extend({parse:function(a){var b={};typeof a==="string"&&(a=(new window.DOMParser).parseFromString(a,"text/xml"));b.title=$("title",a).text();b.body=$("body",a);b.toc_ids=[];$(b.body).find("nav[epub\\:type='toc'] a[href*='#']").each(function(a,d){b.toc_ids.push(d.getAttribute("href").split("#")[1])});return b},findNearestTocItemSelector:function(a){var b=null;if(a!=null){var c=a.getAttribute("id");this.get("toc_ids").indexOf(c)>-1?b="a[href$='#"+c+"']":a.previousElementSibling!=
null?b=this.findNearestTocItemSelector(a.previousElementSibling):a.parentElement!=null&&(b=this.findNearestTocItemSelector(a.parentElement))}return b},TocView:function(){return new Readium.Views.XhtmlTocView({model:this})}});
