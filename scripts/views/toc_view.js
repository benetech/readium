Readium.Views.TocViewBase=Backbone.View.extend({el:"#readium-toc",initialize:function(){this.model.on("change",this.render,this);this.model.on("change:visible",this.setVisibility,this)},events:{"click a":"handleClick","click #close-toc-button":"closeToc","keyup #close-toc-button":"closeToc"},setVisibility:function(){this.$el.toggle(this.model.get("visible"))},handleClick:function(a){a.preventDefault();href=$(a.currentTarget).attr("href");this.model.hide();this.model.handleLink(href);a=BookshareUtils.getSplitUrl(href);
a[1]&&BookshareUtils.setFocus(a[2])},handlePageSelect:function(a){a=a.target[a.target.selectedIndex].value;this.model.hide();this.model.handleLink(a);a=BookshareUtils.getSplitUrl(a);a[1]&&BookshareUtils.setFocus(a[2])},closeToc:function(a){if(a.type=="click"||a.type=="keyup"&&a.keyCode==13)a.preventDefault(),this.model.hide()},scrollToNavItem:function(a){var b=a.getClientRects()[0].top,a=this.$("#toc-body");b+=this.$("#toc-header").height();a.scrollTop(a.scrollTop()+b-Math.ceil(a.height()*0.4))}});
Readium.Views.NcxTocView=Readium.Views.TocViewBase.extend({initialize:function(){Readium.Views.TocViewBase.prototype.initialize.call(this);this.nav_template=Handlebars.templates.ncx_nav_template},render:function(){this.setVisibility();for(var a=$("<ol></ol>"),b=this.model.get("navs"),c=0;c<b.length;c++)a.append(this.nav_template(b[c]));this.$("#toc-body").html("<h1 tabindex='-1' id='toc-heading-ref'>"+(this.model.get("title")||"Table of Contents")+"</h1>");this.$("#toc-body").append(a);this.$("#toc-body").append("<div id='toc-end-spacer'>");
return this}});
Readium.Views.XhtmlTocView=Readium.Views.TocViewBase.extend({events:{"click a":"handleClick","click #close-toc-button":"closeToc","keyup #close-toc-button":"closeToc","change #toc-page-select":"handlePageSelect"},render:function(){this.$("#toc-body").html(this.model.get("body").html());this.formatPageListNavigation();this.$("#toc-body").append("<div id='toc-end-spacer'>");this.model.get("visible")&&this.renderTocHighlight();return this},renderTocHighlight:function(){var a=this.model.get("toc_highlight_selector");a&&
this.scrollToNavItem(this.$("#toc-body").find(a).addClass("tocHighlight")[0])},formatPageListNavigation:function(){var a,b;a=this.$("nav").filter(function(){if($(this).attr("epub:type")==="page-list")return $(this).attr("id","page-list-select"),$(this).hide(),!0});b=$("#toc-page-select");a=a.find("a").not(":empty");b.length==0&&a.length!=0&&(b=$("<select id='toc-page-select'></select>"),$("#toc-page-nav").prepend(b).prepend("<label for='toc-page-select'>Go to page:</label> "),b.append($("<option/>",
{disabled:!0,selected:!0})),a.each(function(){var a=$(this);b.append($("<option/>",{value:a.attr("href"),text:a.text()}))}))}});
